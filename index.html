<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.M. EstÃ©tica Automotiva</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Montserrat', sans-serif;
      background-color: #121212; color: #f0e6d2;
    }
    header {
      background: #7f1d1d; color: #ffdd57; padding: 20px;
      text-align: center; font-size: 1.8rem; font-weight: 700;
    }
    nav {
      display: flex; background: #1f1f1f;
    }
    nav button {
      flex: 1; padding: 15px; border: none; background: #2a2a2a;
      color: #f0e6d2; font-weight: 700; font-size: 1rem;
      cursor: pointer; transition: 0.3s ease;
    }
    nav button:hover, nav button.active {
      background: #7f1d1d; color: #ffdd57;
    }
    section {
      display: none; padding: 20px;
      animation: fade 0.3s ease;
    }
    section.active { display: block; }
    @keyframes fade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input, select, textarea, button {
      width: 100%; margin: 10px 0; padding: 12px;
      border-radius: 8px; border: none; font-size: 1rem;
      font-family: 'Montserrat', sans-serif;
    }
    button[type="submit"] {
      background-color: #7f1d1d; color: #ffdd57;
      font-weight: bold; cursor: pointer;
    }
    ul { list-style: none; padding: 0; }
    li {
      background: #222; margin-bottom: 10px;
      padding: 15px; border-radius: 6px;
      display: flex; justify-content: space-between;
    }
    .orcamento-box {
      white-space: pre-line; background-color: #1b1b1b;
      border: 2px solid #7f1d1d; padding: 15px; border-radius: 10px;
      margin-top: 20px; font-family: monospace;
      color: #ffdd57;
    }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    .actions button {
      flex: 1; padding: 10px; background: #7f1d1d;
      color: #ffdd57; border: none; border-radius: 6px;
      cursor: pointer; font-weight: 700;
    }
    .actions button:hover {
      background: #aa2e2e;
    }
  </style>
</head>
<body>

<header>âœ¨ R.M. EstÃ©tica Automotiva âœ¨</header>

<nav>
  <button class="active" data-tab="clientes">ğŸ‘¤ Clientes</button>
  <button data-tab="servicos">ğŸ›  ServiÃ§os</button>
  <button data-tab="orcamento">ğŸ“‹ OrÃ§amento</button>
  <button data-tab="historico">ğŸ“œ HistÃ³rico</button>
</nav>

<section id="clientes" class="active">
  <h2>ğŸ‘¤ Cadastro de Clientes</h2>
  <form id="form-clientes">
    <input type="text" id="nome" placeholder="Nome completo" required />
    <input type="tel" id="telefone" placeholder="Telefone (opcional)" />
    <input type="text" id="carro" placeholder="Carro (opcional)" />
    <input type="text" id="placa" placeholder="Placa (opcional)" />
    <button type="submit">Salvar Cliente ğŸ’¾</button>
  </form>
  <ul id="lista-clientes"></ul>
</section>

<section id="servicos">
  <h2>ğŸ›  Cadastro de ServiÃ§os</h2>
  <form id="form-servicos">
    <input type="text" id="descricao" placeholder="DescriÃ§Ã£o do serviÃ§o" required />
    <input type="number" id="valor" placeholder="Valor R$" min="0" step="0.01" required />
    <button type="submit">Salvar ServiÃ§o ğŸ’¾</button>
  </form>
  <ul id="lista-servicos"></ul>
</section>

<section id="orcamento">
  <h2>ğŸ“‹ Gerar OrÃ§amento</h2>
  <form id="form-orcamento">
    <select id="select-cliente" required></select>
    <select id="select-servico" required></select>
    <input type="number" id="desconto" placeholder="Desconto (%)" min="0" max="100" step="1" />
    <button type="submit">Salvar OrÃ§amento ğŸ’¾</button>
  </form>
</section>

<section id="historico">
  <h2>ğŸ“œ HistÃ³rico de OrÃ§amentos</h2>
  <ul id="lista-orcamentos"></ul>
  <pre id="orcamento-box" class="orcamento-box"></pre>
  <div class="actions">
    <button id="btnSalvarOrcamento">Salvar OrÃ§amento ğŸ’¾</button>
    <button id="btnEnviarOrcamento">Enviar OrÃ§amento ğŸ“¤</button>
    <button id="btnSalvarCupom">Salvar Cupom ğŸ’¾</button>
    <button id="btnEnviarCupom">Enviar Cupom ğŸ“¤</button>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    'https://zkdfimbfwgofkmmcvyfu.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...REDACTED...'
  );

  const tabs = document.querySelectorAll("nav button");
  const sections = document.querySelectorAll("section");
  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      sections.forEach(s => s.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  async function carregarClientes() {
    const { data } = await supabase.from("clientes").select("*").order("nome");
    const ul = document.getElementById("lista-clientes");
    const select = document.getElementById("select-cliente");
    ul.innerHTML = "";
    select.innerHTML = "<option disabled selected>Selecione o cliente</option>";
    data.forEach(c => {
      ul.innerHTML += `<li><span>${c.nome} - ${c.carro || ""} (${c.placa || ""})</span><button onclick="excluirCliente(${c.id})">âŒ</button></li>`;
      select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    });
  }

  async function carregarServicos() {
    const { data } = await supabase.from("servicos").select("*").order("descricao");
    const ul = document.getElementById("lista-servicos");
    const select = document.getElementById("select-servico");
    ul.innerHTML = "";
    select.innerHTML = "<option disabled selected>Selecione o serviÃ§o</option>";
    data.forEach(s => {
      ul.innerHTML += `<li><span>${s.descricao} - R$ ${s.valor.toFixed(2)}</span><button onclick="excluirServico(${s.id})">âŒ</button></li>`;
      select.innerHTML += `<option value="${s.id}">${s.descricao}</option>`;
    });
  }

  async function carregarOrcamentos() {
    const { data } = await supabase.from("orcamentos").select(`
      id, desconto, created_at,
      clientes (nome, carro, placa),
      servicos (descricao, valor)
    `).order("created_at", { ascending: false });
    const ul = document.getElementById("lista-orcamentos");
    ul.innerHTML = "";
    data.forEach(o => {
      const total = o.servicos.valor * (1 - (o.desconto || 0) / 100);
      const texto = `ğŸ§¾ OrÃ§amento R.M. EstÃ©tica Automotiva ğŸ§¾

==============================
   R.M. ESTÃ‰TICA AUTOMOTIVA
==============================
Data: ${new Date(o.created_at).toLocaleString()}
Cliente: ${o.clientes.nome}
Carro: ${o.clientes.carro || "-"} (${o.clientes.placa || "-"})
------------------------------
SERVIÃ‡OS:
- ${o.servicos.descricao}  R$ ${o.servicos.valor.toFixed(2)}
------------------------------
Desconto: ${o.desconto || 0}%
Total: R$ ${total.toFixed(2)}
------------------------------
LOJA PARA CONTATO:
Tel: 24 999486232
EndereÃ§o:
Rua 40, Travessa Recanto dos PÃ¡ssaros
==============================
   Obrigado pela preferÃªncia!
==============================`;

      ul.innerHTML += `<li><span><strong>${o.clientes.nome}</strong> â€” ${o.servicos.descricao} â€¢ R$ ${total.toFixed(2)}</span><button onclick="mostrarOrcamento(\`${texto.replace(/`/g, "\\`")}\`)">ğŸ‘ï¸</button></li>`;
    });
  }

  function mostrarOrcamento(texto) {
    document.getElementById("orcamento-box").textContent = texto;
  }

  document.getElementById("btnSalvarOrcamento").onclick = () => {
    const t = document.getElementById("orcamento-box").textContent;
    if (!t) return alert("Visualize um orÃ§amento antes!");
    salvarTexto(t, "orcamento.txt");
  };
  document.getElementById("btnSalvarCupom").onclick = () => {
    const t = document.getElementById("orcamento-box").textContent;
    if (!t) return alert("Visualize um cupom antes!");
    salvarTexto(t, "cupom.txt");
  };
  document.getElementById("btnEnviarOrcamento").onclick = () => {
    const t = document.getElementById("orcamento-box").textContent;
    if (!t) return alert("Visualize antes!");
    window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, "_blank");
  };
  document.getElementById("btnEnviarCupom").onclick = () => {
    const t = document.getElementById("orcamento-box").textContent;
    if (!t) return alert("Visualize antes!");
    window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, "_blank");
  };

  function salvarTexto(conteudo, nome) {
    const blob = new Blob([conteudo], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = nome;
    a.click();
  }

  async function excluirCliente(id) {
    if (confirm("Confirma excluir cliente?")) {
      await supabase.from("clientes").delete().eq("id", id);
      carregarClientes();
    }
  }
  async function excluirServico(id) {
    if (confirm("Confirma excluir serviÃ§o?")) {
      await supabase.from("servicos").delete().eq("id", id);
      carregarServicos();
    }
  }

  document.getElementById("form-clientes").addEventListener("submit", async e => {
    e.preventDefault();
    const nome = e.target.nome.value.trim();
    const telefone = e.target.telefone.value.trim();
    const carro = e.target.carro.value.trim();
    const placa = e.target.placa.value.trim();
    if (!nome) return alert("Nome obrigatÃ³rio");
    await supabase.from("clientes").insert([{ nome, telefone, carro, placa }]);
    e.target.reset();
    carregarClientes();
  });

  document.getElementById("form-servicos").addEventListener("submit", async e => {
    e.preventDefault();
    const descricao = e.target.descricao.value.trim();
    const valor = parseFloat(e.target.valor.value);
    if (!descricao || valor <= 0) return alert("Preencha corretamente");
    await supabase.from("servicos").insert([{ descricao, valor }]);
    e.target.reset();
    carregarServicos();
  });

  document.getElementById("form-orcamento").addEventListener("submit", async e => {
    e.preventDefault();
    const clienteId = parseInt(e.target["select-cliente"].value);
    const servicoId = parseInt(e.target["select-servico"].value);
    const desconto = parseFloat(e.target["desconto"].value) || 0;
    if (!clienteId || !servicoId) return alert("Selecione tudo");
    await supabase.from("orcamentos").insert([{ cliente_id: clienteId, servico_id: servicoId, desconto }]);
    e.target.reset();
    carregarOrcamentos();
    alert("OrÃ§amento salvo com sucesso!");
  });

  // InicializaÃ§Ã£o
  (async () => {
    await carregarClientes();
    await carregarServicos();
    await carregarOrcamentos();
  })();
</script>

</body>
</html>
