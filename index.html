<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.M. EstÃ©tica Automotiva</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #121212;
      color: #f0e6d2;
    }
    header {
      background: #7f1d1d;
      color: #ffdd57;
      text-align: center;
      padding: 20px;
      font-size: 1.6rem;
      font-weight: bold;
    }
    nav {
      display: flex;
      justify-content: space-around;
      background: #1f1f1f;
      box-shadow: inset 0 -2px 5px #000;
    }
    nav button {
      flex: 1;
      padding: 15px;
      border: none;
      background: #2a2a2a;
      color: #f0e6d2;
      font-size: 1rem;
      cursor: pointer;
    }
    nav button.active {
      background: #7f1d1d;
      color: #ffdd57;
    }
    section {
      display: none;
      padding: 20px;
      animation: fade 0.3s ease-in-out;
    }
    section.active {
      display: block;
    }
    @keyframes fade {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    input, select, textarea, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
    }
    input, select, textarea {
      background: #1e1e1e;
      color: #f0e6d2;
    }
    button {
      background: #7f1d1d;
      color: #ffdd57;
      font-weight: bold;
    }
    button:hover {
      background: #aa2e2e;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #222;
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
    }
    .orcamento-box {
      background: #1a1a1a;
      color: #ffdd57;
      white-space: pre-wrap;
      padding: 15px;
      border: 2px solid #7f1d1d;
      border-radius: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<header>âœ¨ R.M. EstÃ©tica Automotiva âœ¨</header>

<nav>
  <button class="active" data-tab="clientes">ğŸ‘¤ Clientes</button>
  <button data-tab="servicos">ğŸ›  ServiÃ§os</button>
  <button data-tab="orcamento">ğŸ“‹ OrÃ§amento</button>
  <button data-tab="historico">ğŸ“œ HistÃ³rico</button>
</nav>

<section id="clientes" class="active">
  <h2>ğŸ‘¤ Cadastro de Clientes</h2>
  <form id="form-clientes">
    <input type="text" id="nome" placeholder="Nome completo" required />
    <input type="tel" id="telefone" placeholder="Telefone" />
    <input type="text" id="carro" placeholder="Carro" />
    <input type="text" id="placa" placeholder="Placa" />
    <button type="submit">Salvar Cliente ğŸ’¾</button>
  </form>
  <ul id="lista-clientes"></ul>
</section>

<section id="servicos">
  <h2>ğŸ›  Cadastro de ServiÃ§os</h2>
  <form id="form-servicos">
    <input type="text" id="descricao" placeholder="DescriÃ§Ã£o do serviÃ§o" required />
    <input type="number" id="valor" placeholder="Valor R$" min="0" step="0.01" required />
    <button type="submit">Salvar ServiÃ§o ğŸ’¾</button>
  </form>
  <ul id="lista-servicos"></ul>
</section>

<section id="orcamento">
  <h2>ğŸ“‹ Gerar OrÃ§amento</h2>
  <form id="form-orcamento">
    <select id="select-cliente" required></select>
    <select id="select-servico" required></select>
    <input type="number" id="desconto" placeholder="Desconto (%)" min="0" max="100" />
    <button type="submit">Salvar OrÃ§amento ğŸ’¾</button>
  </form>
</section>

<section id="historico">
  <h2>ğŸ“œ HistÃ³rico de OrÃ§amentos</h2>
  <ul id="lista-orcamentos"></ul>
  <pre id="orcamento-box" class="orcamento-box"></pre>
  <button id="btnSalvarOrcamento">Salvar OrÃ§amento ğŸ’¾</button>
  <button id="btnEnviarOrcamento">Enviar OrÃ§amento ğŸ“¤</button>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    'https://zkdfimbfwgofkmmcvyfu.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE'
  );

  document.querySelectorAll("nav button").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  async function carregarClientes() {
    const { data } = await supabase.from("clientes").select("*").order("nome");
    const ul = document.getElementById("lista-clientes");
    const select = document.getElementById("select-cliente");
    ul.innerHTML = "";
    select.innerHTML = '<option value="">Selecione o cliente</option>';
    data.forEach(c => {
      ul.innerHTML += `<li>${c.nome} - ${c.carro || ''} (${c.placa || ''})</li>`;
      select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    });
  }

  async function carregarServicos() {
    const { data } = await supabase.from("servicos").select("*").order("descricao");
    const ul = document.getElementById("lista-servicos");
    const select = document.getElementById("select-servico");
    ul.innerHTML = "";
    select.innerHTML = '<option value="">Selecione o serviÃ§o</option>';
    data.forEach(s => {
      ul.innerHTML += `<li>${s.descricao} - R$ ${s.valor.toFixed(2)}</li>`;
      select.innerHTML += `<option value="${s.id}">${s.descricao}</option>`;
    });
  }

  async function carregarOrcamentos() {
    const { data } = await supabase.from("orcamentos").select(`
      id, desconto, created_at,
      clientes (nome, carro, placa),
      servicos (descricao, valor)
    `).order("created_at", { ascending: false });

    const ul = document.getElementById("lista-orcamentos");
    ul.innerHTML = "";
    data.forEach(o => {
      const total = o.servicos.valor * (1 - (o.desconto || 0)/100);
      const texto = `
ğŸ§¾ OrÃ§amento R.M. EstÃ©tica Automotiva ğŸ§¾

Data: ${new Date(o.created_at).toLocaleString()}
Cliente: ${o.clientes.nome}
Carro: ${o.clientes.carro || '-'} (${o.clientes.placa || '-'})
ServiÃ§o: ${o.servicos.descricao}
Valor: R$ ${o.servicos.valor.toFixed(2)}
Desconto: ${o.desconto || 0}%
Total: R$ ${total.toFixed(2)}

Obrigado pela preferÃªncia!`;
      ul.innerHTML += `<li><strong>${o.clientes.nome}</strong> â€” R$ ${total.toFixed(2)}<br/><button onclick="document.getElementById('orcamento-box').textContent = \`${texto}\`">ğŸ‘ï¸ Visualizar</button></li>`;
    });
  }

  document.getElementById("form-clientes").addEventListener("submit", async e => {
    e.preventDefault();
    const nome = e.target.nome.value;
    const telefone = e.target.telefone.value;
    const carro = e.target.carro.value;
    const placa = e.target.placa.value;
    await supabase.from("clientes").insert([{ nome, telefone, carro, placa }]);
    e.target.reset();
    carregarClientes();
  });

  document.getElementById("form-servicos").addEventListener("submit", async e => {
    e.preventDefault();
    const descricao = e.target.descricao.value;
    const valor = parseFloat(e.target.valor.value);
    await supabase.from("servicos").insert([{ descricao, valor }]);
    e.target.reset();
    carregarServicos();
  });

  document.getElementById("form-orcamento").addEventListener("submit", async e => {
    e.preventDefault();
    const cliente_id = parseInt(e.target["select-cliente"].value);
    const servico_id = parseInt(e.target["select-servico"].value);
    const desconto = parseFloat(e.target.desconto.value || 0);
    await supabase.from("orcamentos").insert([{ cliente_id, servico_id, desconto }]);
    e.target.reset();
    carregarOrcamentos();
    alert("OrÃ§amento salvo!");
  });

  document.getElementById("btnSalvarOrcamento").addEventListener("click", () => {
    const texto = document.getElementById("orcamento-box").textContent;
    if (texto) {
      const blob = new Blob([texto], {type: "text/plain"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "orcamento.txt";
      link.click();
    } else {
      alert("Visualize um orÃ§amento antes.");
    }
  });

  document.getElementById("btnEnviarOrcamento").addEventListener("click", () => {
    const texto = document.getElementById("orcamento-box").textContent;
    if (texto) {
      const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
      window.open(url, "_blank");
    } else {
      alert("Visualize um orÃ§amento antes.");
    }
  });

  carregarClientes();
  carregarServicos();
  carregarOrcamentos();
</script>
</body>
</html>
