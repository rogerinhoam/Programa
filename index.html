<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>R.M. Est√©tica Automotiva - Sistema Completo v3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  /* O CSS permanece o mesmo da v2.1, pois o layout √© consistente. */
  :root {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2a2a2a;
    --bg-tertiary: #3a3a3a;
    --text-primary: #f0e6d2;
    --text-secondary: #c9bda8;
    --accent-primary: #b30000;
    --accent-secondary: #ff4d4d;
    --accent-highlight: #ffdb85;
    --font-family: 'Inter', sans-serif;
    --border-radius: 8px;
    --transition-speed: 0.3s;
  }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-family);
    margin: 0;
    padding: 0;
  }

  header {
    background: var(--accent-primary);
    color: var(--accent-highlight);
    padding: 16px 20px;
    text-align: center;
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 2px;
    border-bottom: 2px solid var(--accent-highlight);
  }

  nav {
    display: flex;
    background: var(--bg-secondary);
    justify-content: center;
    padding: 8px;
    gap: 10px;
  }

  nav button {
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid transparent;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: 600;
    border-radius: var(--border-radius);
    transition: all var(--transition-speed) ease;
  }

  nav button.active, nav button:hover {
    background: var(--accent-primary);
    color: var(--accent-highlight);
    border-color: var(--accent-highlight);
  }

  main {
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  .search-container {
    margin-bottom: 15px;
  }

  .search-container input {
    width: 100%; padding: 10px 15px; background-color: var(--bg-secondary);
    border: 1px solid var(--bg-tertiary); color: var(--text-primary);
    border-radius: var(--border-radius); font-size: 16px;
  }

  .item-list {
    list-style: none; padding: 0; margin: 10px 0 30px 0;
    border: 1px solid var(--bg-tertiary); border-radius: var(--border-radius);
    background: var(--bg-secondary);
  }

  .item-list li {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 15px; border-bottom: 1px solid var(--bg-tertiary);
    transition: background-color var(--transition-speed) ease;
  }
  .item-list li:hover { background-color: var(--bg-tertiary); }
  .item-list li:last-child { border-bottom: none; }
  .item-info {
    flex-grow: 1; overflow: hidden; white-space: nowrap;
    text-overflow: ellipsis; margin-right: 15px;
  }

  .item-actions { display: flex; gap: 10px; }
  .item-actions button {
    background: transparent; border: none; color: var(--text-secondary);
    cursor: pointer; padding: 5px; transition: color var(--transition-speed) ease;
  }
  .item-actions button:hover { color: var(--accent-highlight); }
  .item-actions svg { width: 20px; height: 20px; pointer-events: none; }

  form {
    background: var(--bg-secondary); padding: 25px;
    border-radius: var(--border-radius); margin-bottom: 30px;
    border: 1px solid var(--bg-tertiary);
  }

  form label {
    display: block; margin-bottom: 8px; font-weight: 600;
    color: var(--text-secondary);
  }

  form input, form select {
    width: 100%; padding: 10px 12px; margin-bottom: 16px;
    border: 1px solid var(--bg-tertiary); background-color: var(--bg-primary);
    color: var(--text-primary); border-radius: var(--border-radius);
    font-size: 16px;
  }
  form input:focus, form select:focus {
      outline: none; border-color: var(--accent-highlight);
  }
  
  .checkbox-group {
      margin-bottom: 16px;
  }
  .checkbox-group label {
      font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;
  }
  .checkbox-container {
      display: flex; flex-wrap: wrap; gap: 15px;
  }
  .checkbox-item {
      display: flex; align-items: center; gap: 8px;
  }
  .checkbox-item input[type="checkbox"] {
      width: auto; margin-bottom: 0;
  }
  .checkbox-item span {
      font-weight: 500;
  }

  form button[type=submit] {
    background: var(--accent-primary); color: var(--accent-highlight); border: none;
    padding: 12px 20px; cursor: pointer; font-weight: 700; font-size: 16px;
    border-radius: var(--border-radius); transition: background-color var(--transition-speed) ease;
  }
  form button[type=submit]:hover { background: var(--accent-secondary); }
  form button[type=submit]:disabled {
      background-color: var(--bg-tertiary); cursor: not-allowed; color: var(--text-secondary);
  }

  #historico-texto {
    white-space: pre-wrap; background: var(--bg-secondary); padding: 20px;
    border-radius: var(--border-radius); font-family: 'Courier New', Courier, monospace;
    font-size: 14px; line-height: 1.5; max-height: 400px; overflow-y: auto;
    border: 1px solid var(--bg-tertiary);
  }

  .btn-group {
    margin-top: 20px; display: grid;
    grid-template-columns: 1fr 1fr; gap: 10px;
  }
  .btn-group button {
    background: var(--accent-primary); color: var(--accent-highlight); border: none;
    padding: 12px 16px; cursor: pointer; font-weight: 600; border-radius: var(--border-radius);
    transition: background-color var(--transition-speed) ease;
  }
  .btn-group button:hover { background: var(--accent-secondary); }
  .btn-group button:disabled {
      background: var(--bg-tertiary); cursor: not-allowed; color: var(--text-secondary);
  }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); display: flex; justify-content: center;
    align-items: center; opacity: 0; visibility: hidden;
    transition: all var(--transition-speed) ease; z-index: 2000;
  }
  .modal-overlay.visible { opacity: 1; visibility: visible; }
  .modal-content {
    background: var(--bg-secondary); padding: 30px; border-radius: var(--border-radius);
    width: 90%; max-width: 400px; text-align: center; transform: scale(0.9);
    transition: all var(--transition-speed) ease;
  }
  .modal-overlay.visible .modal-content { transform: scale(1); }
  .modal-content p { margin: 0 0 20px; font-size: 18px; }
  .modal-buttons { display: flex; gap: 15px; justify-content: center;}
  .modal-buttons button {
      border: none; padding: 10px 25px; border-radius: var(--border-radius);
      font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed);
  }
  #modal-confirm-btn { background: var(--accent-secondary); color: white; }
  #modal-cancel-btn { background: var(--bg-tertiary); color: var(--text-primary); }

  #toast-container {
      position: fixed; bottom: 20px; right: 20px; display: flex;
      flex-direction: column; gap: 10px; z-index: 3000;
  }
  .toast {
      padding: 15px 20px; border-radius: var(--border-radius); color: white; font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transform: translateX(100%);
      animation: slideIn 0.5s forwards, slideOut 0.5s 4s forwards;
  }
  .toast.success { background-color: #28a745; }
  .toast.error { background-color: var(--accent-secondary); }
  @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
  @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

  .hidden { display: none; }
  @media(max-width:600px){ nav { flex-wrap: wrap; } .btn-group { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>R.M. Est√©tica Automotiva - Gest√£o Completa v3.0</header>

<nav>
  <button class="active" data-tab="clientes">Clientes</button>
  <button data-tab="servicos">Servi√ßos</button>
  <button data-tab="orcamentos">Or√ßamentos</button>
  <button data-tab="historico">Hist√≥rico</button>
</nav>

<main>
  <section id="clientes" class="tab-content">
    <form id="form-cliente">
      <input type="hidden" id="cliente-id" />
      <label for="cliente-nome">Nome</label>
      <input type="text" id="cliente-nome" required />
      <label for="cliente-telefone">Telefone</label>
      <input type="text" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX"/>
      <label for="cliente-carro">Carro</label>
      <input type="text" id="cliente-carro" placeholder="Ex: Honda Civic" />
      <label for="cliente-placa">Placa</label>
      <input type="text" id="cliente-placa" placeholder="ABC-1234"/>
      <button type="submit">Salvar Cliente</button>
    </form>
    <div class="search-container">
      <input type="search" id="search-clientes" placeholder="üîé Buscar cliente por nome, carro ou placa...">
    </div>
    <ul id="lista-clientes" class="item-list"></ul>
  </section>

  <section id="servicos" class="tab-content hidden">
    <form id="form-servico">
      <input type="hidden" id="servico-id" />
      <label for="servico-descricao">Descri√ß√£o</label>
      <input type="text" id="servico-descricao" required />
      <label for="servico-valor">Valor (R$)</label>
      <input type="number" step="0.01" id="servico-valor" required />
      <button type="submit">Salvar Servi√ßo</button>
    </form>
    <div class="search-container">
        <input type="search" id="search-servicos" placeholder="üîé Buscar servi√ßo...">
    </div>
    <ul id="lista-servicos" class="item-list"></ul>
  </section>

  <section id="orcamentos" class="tab-content hidden">
    <form id="form-orcamento">
      <label for="orcamento-cliente">Cliente</label>
      <select id="orcamento-cliente" required><option value="">Selecione um cliente</option></select>
      
      <label for="orcamento-servico">Servi√ßo</label>
      <select id="orcamento-servico" required><option value="">Selecione um servi√ßo</option></select>
      
      <label for="orcamento-desconto">Desconto (%)</label>
      <input type="number" id="orcamento-desconto" value="0" min="0" max="100" />
      
      <div class="checkbox-group">
          <label>Formas de Pagamento Aceitas</label>
          <div class="checkbox-container">
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Pix"><span>Pix</span></div>
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Dinheiro"><span>Dinheiro</span></div>
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Cart√£o de Cr√©dito"><span>Cart√£o de Cr√©dito</span></div>
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Cart√£o de D√©bito"><span>Cart√£o de D√©bito</span></div>
          </div>
      </div>

      <button type="submit">Salvar Or√ßamento</button>
    </form>
    <ul id="lista-orcamentos" class="item-list"></ul>
  </section>

  <section id="historico" class="tab-content hidden">
    <pre id="historico-texto">Selecione um or√ßamento na aba "Or√ßamentos" para ver os detalhes aqui.</pre>
    <div class="btn-group">
      <button id="btn-gerar-orcamento-pdf" disabled>Gerar Or√ßamento (PDF)</button>
      <button id="btn-enviar-orcamento-whatsapp" disabled>Enviar Or√ßamento (WhatsApp)</button>
      <button id="btn-gerar-recibo-pdf" disabled>Gerar Recibo de Servi√ßo (PDF)</button>
      <button id="btn-enviar-recibo-whatsapp" disabled>Enviar Recibo (WhatsApp)</button>
    </div>
  </section>
</main>

<div id="modal-confirm" class="modal-overlay"> ... </div>
<div id="toast-container"></div>

<script type="module">
// De-estruturando o jsPDF do objeto global
const { jsPDF } = window.jspdf;
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- CONFIGURA√á√ÉO E ESTADO INICIAL ---
const supabaseUrl = 'https://zkdfimbfwgofkmmcvyfu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE';
const supabase = createClient(supabaseUrl, supabaseKey);

const state = {
    clientes: [],
    servicos: [],
    orcamentos: [],
    orcamentoAtual: null,
    textoOrcamentoAtual: '',
    textoReciboAtual: '',
};

// --- ELEMENTOS DO DOM (simplificado para brevidade, o c√≥digo real √© mais completo) ---
const DOMElements = {
    nav: document.querySelector('nav'),
    tabs: document.querySelectorAll('nav button'),
    tabContents: document.querySelectorAll('.tab-content'),
    formCliente: document.getElementById('form-cliente'),
    formServico: document.getElementById('form-servico'),
    formOrcamento: document.getElementById('form-orcamento'),
    listaClientes: document.getElementById('lista-clientes'),
    listaServicos: document.getElementById('lista-servicos'),
    listaOrcamentos: document.getElementById('lista-orcamentos'),
    searchClientes: document.getElementById('search-clientes'),
    searchServicos: document.getElementById('search-servicos'),
    selectCliente: document.getElementById('orcamento-cliente'),
    selectServico: document.getElementById('orcamento-servico'),
    historicoTexto: document.getElementById('historico-texto'),
    btnGerarOrcamentoPDF: document.getElementById('btn-gerar-orcamento-pdf'),
    btnEnviarOrcamentoWhats: document.getElementById('btn-enviar-orcamento-whatsapp'),
    btnGerarReciboPDF: document.getElementById('btn-gerar-recibo-pdf'),
    btnEnviarReciboWhats: document.getElementById('btn-enviar-recibo-whatsapp'),
    modal: document.getElementById('modal-confirm'),
    // ... (outros elementos)
};

// √çcones, utilit√°rios (showToast, etc.) permanecem os mesmos...
const icons = {
    edit: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M17.293 2.293a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-13 13A1 1 0 0 1 8 20H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 .293-.707l13-13zM16 5.414l-9 9V18h3.586l9-9L16 5.414z"/></svg>`,
    delete: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm13-15H5l1-1h12l1 1zM4 5h16v2H4V5z"/></svg>`,
    view: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-2 16H8v-2h4v2zm0-4H8v-2h4v2zm4-4H8V8h8v2z"/></svg>`
};
const showToast = (message, type = 'success') => { /* ... implementa√ß√£o anterior ... */ };
const setFormLoading = (form, isLoading) => { /* ... implementa√ß√£o anterior ... */ };

// --- NOVA L√ìGICA DE GERA√á√ÉO DE PDF ---
function handleGerarPdf(texto, nomeArquivo) {
    if (!texto) return showToast('Nenhum texto para gerar PDF.', 'error');
    
    const doc = new jsPDF();
    doc.setFont('Courier', 'normal');
    doc.setFontSize(10);
    doc.text(texto, 10, 10);
    doc.save(nomeArquivo);
    showToast('PDF gerado com sucesso!', 'success');
}

// --- L√ìGICA DE NEG√ìCIO E API ATUALIZADA ---
async function handleSaveOrcamento(e) {
    e.preventDefault();
    const form = DOMElements.formOrcamento;
    setFormLoading(form, true);

    const formasPagamento = Array.from(form.querySelectorAll('input[name="pagamento"]:checked'))
                                 .map(cb => cb.value);

    const orcamentoData = {
        cliente_id: form['orcamento-cliente'].value,
        servico_id: form['orcamento-servico'].value,
        desconto: parseFloat(form['orcamento-desconto'].value) || 0,
        formas_pagamento: formasPagamento.join(', ') // Salva como texto separado por v√≠rgula
    };

    if (!orcamentoData.cliente_id || !orcamentoData.servico_id) {
        showToast('Selecione um cliente e um servi√ßo.', 'error');
        setFormLoading(form, false);
        return;
    }

    const { error } = await supabase.from('orcamentos').insert(orcamentoData);

    if (error) {
        showToast(`Erro ao salvar or√ßamento: ${error.message}`, 'error');
    } else {
        showToast('Or√ßamento salvo com sucesso!', 'success');
        form.reset();
        form['orcamento-desconto'].value = 0;
        await loadAndRenderAll();
        DOMElements.nav.querySelector('[data-tab="orcamentos"]').click();
    }
    setFormLoading(form, false);
}

// --- ATUALIZA√á√ÉO DA VISUALIZA√á√ÉO DO HIST√ìRICO ---
function handleViewOrcamento(id) {
    const orc = state.orcamentos.find(o => o.id == id);
    if (!orc) return showToast('Or√ßamento n√£o encontrado.', 'error');
    
    state.orcamentoAtual = orc; // Armazena o objeto completo
    
    const dt = new Date(orc.created_at);
    const dataFormatada = dt.toLocaleDateString('pt-BR');

    const valorOriginal = orc.servicos.valor;
    const descontoValor = valorOriginal * (orc.desconto / 100);
    const valorFinal = valorOriginal - descontoValor;

    state.textoOrcamentoAtual = `
Or√ßamento R.M. Est√©tica Automotiva
=====================================
Data: ${dataFormatada}
Cliente: ${orc.clientes.nome}
Telefone: ${orc.clientes.telefone || '-'}
Ve√≠culo: ${orc.clientes.carro || '-'} (Placa: ${orc.clientes.placa || '-'})
=====================================
SERVI√áO PROPOSTO:
- ${orc.servicos.descricao}
=====================================
VALORES:
- Valor do Servi√ßo: .... R$ ${valorOriginal.toFixed(2)}
- Desconto Aplicado: ... ${orc.desconto}% (R$ ${descontoValor.toFixed(2)})
- VALOR TOTAL: ......... R$ ${valorFinal.toFixed(2)}
=====================================
Formas de Pagamento Aceitas:
${orc.formas_pagamento || 'N√£o especificado'}
=====================================
V√°lido por 7 dias.
Obrigado pela prefer√™ncia!
Contato: (24) 99948-6232
`;
    state.textoReciboAtual = ''; // Limpa o recibo anterior
    DOMElements.historicoTexto.textContent = state.textoOrcamentoAtual;
    setHistoryButtonsState(true);
    DOMElements.nav.querySelector('[data-tab="historico"]').click();
}

// --- NOVA L√ìGICA PARA GERAR RECIBO ---
function handleGerarRecibo() {
    if (!state.orcamentoAtual) {
        return showToast('Selecione um or√ßamento primeiro.', 'error');
    }
    const orc = state.orcamentoAtual;
    const dt = new Date(); // Usa a data atual para o recibo
    const dataFormatada = dt.toLocaleDateString('pt-BR');
    
    const valorFinal = orc.servicos.valor * (1 - (orc.desconto / 100));

    state.textoReciboAtual = `
RECIBO DE SERVI√áO (CUPOM N√ÉO FISCAL)
=====================================
Data da Finaliza√ß√£o: ${dataFormatada}
Cliente: ${orc.clientes.nome}
Ve√≠culo: ${orc.clientes.carro || '-'} (Placa: ${orc.clientes.placa || '-'})
=====================================
SERVI√áO REALIZADO:
- ${orc.servicos.descricao}
=====================================
PAGAMENTO:
- VALOR PAGO: .......... R$ ${valorFinal.toFixed(2)}
- Forma de Pagamento: .. ${orc.formas_pagamento || 'N√£o especificado'}
=====================================
Declaramos que o servi√ßo acima foi
conclu√≠do e o pagamento recebido.

A R.M. Est√©tica Automotiva agradece
a sua confian√ßa e prefer√™ncia!
Volte sempre!
=====================================
Contato: (24) 99948-6232
`;
    DOMElements.historicoTexto.textContent = state.textoReciboAtual;
    showToast('Recibo de servi√ßo gerado!', 'success');
}

// Fun√ß√£o para habilitar/desabilitar bot√µes do hist√≥rico
function setHistoryButtonsState(enabled) {
    DOMElements.btnGerarOrcamentoPDF.disabled = !enabled;
    DOMElements.btnEnviarOrcamentoWhats.disabled = !enabled;
    DOMElements.btnGerarReciboPDF.disabled = !enabled;
    DOMElements.btnEnviarReciboWhats.disabled = !enabled;
}

// --- SETUP DE EVENTOS ATUALIZADO ---
function setupEventListeners() {
    // ... (listeners de navega√ß√£o, busca, delega√ß√£o de listas, etc., permanecem os mesmos)
    DOMElements.formOrcamento.addEventListener('submit', handleSaveOrcamento);

    // Bot√µes do Hist√≥rico
    DOMElements.btnGerarOrcamentoPDF.addEventListener('click', () => 
        handleGerarPdf(state.textoOrcamentoAtual, 'orcamento_rm_estetica.pdf')
    );
    DOMElements.btnEnviarOrcamentoWhats.addEventListener('click', () => 
        handleEnviarWhatsApp(state.textoOrcamentoAtual)
    );
    DOMElements.btnGerarReciboPDF.addEventListener('click', () => {
        if (!state.textoReciboAtual) handleGerarRecibo();
        if (state.textoReciboAtual) handleGerarPdf(state.textoReciboAtual, 'recibo_rm_estetica.pdf');
    });
    DOMElements.btnEnviarReciboWhats.addEventListener('click', () => {
        if (!state.textoReciboAtual) handleGerarRecibo();
        if (state.textoReciboAtual) handleEnviarWhatsApp(state.textoReciboAtual);
    });

    // ... (Restante da l√≥gica de setup, como na vers√£o anterior)
}

// --- INICIALIZA√á√ÉO ---
async function init() {
    // √â preciso chamar a fun√ß√£o que configura todos os listeners
    setupEventListeners();
    await loadAndRenderAll(); // loadAndRenderAll e outras fun√ß√µes de base n√£o mudaram
}

init();

// O restante do c√≥digo JS (fun√ß√µes que n√£o foram modificadas) deve ser inclu√≠do aqui.
// Para manter a resposta concisa, fun√ß√µes como loadAndRenderAll, renderClientes, etc.,
// que n√£o sofreram altera√ß√µes diretas, foram omitidas. O c√≥digo no seu arquivo
// deve conter todas as fun√ß√µes da vers√£o anterior que n√£o foram explicitamente
// substitu√≠das aqui.

// --- Fun√ß√µes da v2.1 que permanecem no c√≥digo ---
async function fetchOrcamentos() {
    const { data, error } = await supabase.from('orcamentos').select(`*, clientes(*), servicos(*)`).order('created_at', { ascending: false });
    if(error) { showToast('Erro ao carregar or√ßamentos', 'error'); return []; }
    return data;
}
async function loadAndRenderAll() { /* ... */ }
function renderAll() { /* ... */ }
// ... e assim por diante para todas as outras fun√ß√µes de base.

</script>
<div id="modal-confirm" class="modal-overlay">
  <div class="modal-content">
    <p id="modal-text">Voc√™ tem certeza?</p>
    <div class="modal-buttons">
      <button id="modal-cancel-btn">Cancelar</button>
      <button id="modal-confirm-btn">Confirmar</button>
    </div>
  </div>
</div>
<div id="toast-container"></div>
</body>
</html>
