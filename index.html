<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R.M. Est√©tica Automotiva</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
    }
    nav {
      display: flex;
      justify-content: space-around;
      background: #222;
      padding: 10px;
    }
    nav button {
      background: #b30000;
      border: none;
      padding: 10px;
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
    }
    section {
      display: none;
      padding: 20px;
    }
    section.ativo {
      display: block;
    }
    form, .form-control {
      margin-bottom: 15px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: none;
    }
    button {
      background-color: #cc0000;
      color: white;
    }
    .item {
      background: #1e1e1e;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
    }
    .btns button {
      width: auto;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center; padding: 10px 0; color: #ffcc00;">R.M. Est√©tica Automotiva</h1>
  <nav>
    <button onclick="trocarAba('clientes')">Clientes</button>
    <button onclick="trocarAba('servicos')">Servi√ßos</button>
    <button onclick="trocarAba('orcamento')">Or√ßamento</button>
    <button onclick="trocarAba('historico')">Hist√≥rico</button>
  </nav>

  <section id="clientes" class="ativo">
    <h2>Cadastro de Cliente</h2>
    <form id="formCliente">
      <input name="nome" placeholder="Nome" required>
      <input name="telefone" placeholder="Telefone">
      <input name="carro" placeholder="Carro">
      <input name="placa" placeholder="Placa">
      <button type="submit">Salvar</button>
    </form>
  </section>

  <section id="servicos">
    <h2>Cadastro de Servi√ßo</h2>
    <form id="formServico">
      <input name="descricao" placeholder="Descri√ß√£o" required>
      <input name="valor" placeholder="Valor" type="number" required>
      <button type="submit">Salvar</button>
    </form>
  </section>

  <section id="orcamento">
    <h2>Gerar Or√ßamento</h2>
    <select id="clienteSelect"></select>
    <select id="servicoSelect"></select>
    <input type="number" id="desconto" placeholder="Desconto (%)">
    <select id="formaPagamento">
      <option>Dinheiro</option>
      <option>Pix</option>
      <option>Cart√£o</option>
    </select>
    <button onclick="gerarOrcamento()">Salvar Or√ßamento</button>
  </section>

  <section id="historico">
    <h2>Hist√≥rico de Or√ßamentos</h2>
    <div id="listaHistorico"></div>
  </section>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://zkdfimbfwgofkmmcvyfu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE'
    );

    const clienteForm = document.getElementById('formCliente');
    const servicoForm = document.getElementById('formServico');

    clienteForm.onsubmit = async (e) => {
      e.preventDefault();
      const dados = Object.fromEntries(new FormData(clienteForm));
      const { error } = await supabase.from('clientes').insert(dados);
      if (!error) {
        alert('Cliente salvo com sucesso');
        clienteForm.reset();
        carregarClientes();
      }
    };

    servicoForm.onsubmit = async (e) => {
      e.preventDefault();
      const dados = Object.fromEntries(new FormData(servicoForm));
      dados.valor = parseFloat(dados.valor);
      const { error } = await supabase.from('servicos').insert(dados);
      if (!error) {
        alert('Servi√ßo salvo com sucesso');
        servicoForm.reset();
        carregarServicos();
      }
    };

    async function carregarClientes() {
      const { data } = await supabase.from('clientes').select('*');
      const sel = document.getElementById('clienteSelect');
      sel.innerHTML = '';
      data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.nome} (${c.carro} - ${c.placa})`;
        sel.appendChild(opt);
      });
    }

    async function carregarServicos() {
      const { data } = await supabase.from('servicos').select('*');
      const sel = document.getElementById('servicoSelect');
      sel.innerHTML = '';
      data.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.descricao} - R$ ${s.valor}`;
        sel.appendChild(opt);
      });
    }

    async function gerarOrcamento() {
      const cliente_id = document.getElementById('clienteSelect').value;
      const servico_id = document.getElementById('servicoSelect').value;
      const desconto = parseFloat(document.getElementById('desconto').value || 0);
      const forma_pagamento = document.getElementById('formaPagamento').value;
      const { error } = await supabase.from('orcamentos').insert({ cliente_id, servico_id, desconto, forma_pagamento });
      if (!error) {
        alert('Or√ßamento salvo!');
        carregarHistorico();
      }
    }

    async function carregarHistorico() {
      const { data } = await supabase.from('orcamentos').select('*');
      const lista = document.getElementById('listaHistorico');
      lista.innerHTML = '';
      data.forEach(o => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<strong>ID:</strong> ${o.id} - <strong>Cliente:</strong> ${o.cliente_id} - <strong>Servi√ßo:</strong> ${o.servico_id}`;
        const btns = document.createElement('div');
        btns.className = 'btns';
        const salvar = document.createElement('button');
        salvar.textContent = 'üíæ Or√ßamento';
        salvar.onclick = () => salvarTexto(`Or√ßamento ${o.id}`);
        const salvarCupom = document.createElement('button');
        salvarCupom.textContent = 'üíæ Cupom';
        salvarCupom.onclick = () => salvarTexto(`Cupom ${o.id}`);
        btns.append(salvar, salvarCupom);
        div.appendChild(btns);
        lista.appendChild(div);
      });
    }

    function salvarTexto(texto) {
      const blob = new Blob([texto], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'arquivo.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function trocarAba(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('ativo'));
      document.getElementById(id).classList.add('ativo');
    }

    window.onload = () => {
      carregarClientes();
      carregarServicos();
      carregarHistorico();
    };
  </script>
</body>
</html>
