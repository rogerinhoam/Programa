<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.M. EstÃ©tica Automotiva</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #121212;
      color: #f0e6d2;
    }
    header {
      background: #7f1d1d;
      color: #ffdd57;
      padding: 15px;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      letter-spacing: 1px;
    }
    nav {
      display: flex;
      background-color: #1e1e1e;
    }
    nav button {
      flex: 1;
      padding: 12px;
      border: none;
      background: #2a2a2a;
      color: #f0e6d2;
      font-weight: bold;
      cursor: pointer;
    }
    nav button.active {
      background-color: #7f1d1d;
      color: #ffdd57;
    }
    section {
      display: none;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    section.active {
      display: block;
    }
    form {
      display: flex;
      flex-direction: column;
    }
    input, select {
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: none;
      background-color: #333;
      color: #f0e6d2;
    }
    button {
      background-color: #7f1d1d;
      color: #ffdd57;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background-color: #1f1f1f;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
    }
    .orcamento-box {
      white-space: pre-line;
      background-color: #1b1b1b;
      border: 1px solid #7f1d1d;
      padding: 12px;
      border-radius: 10px;
      color: #ffdd57;
    }
  </style>
</head>
<body>

<header>âœ¨ R.M. EstÃ©tica Automotiva âœ¨</header>

<nav>
  <button class="active" data-tab="clientes">ðŸ‘¤ Clientes</button>
  <button data-tab="servicos">ðŸ›  ServiÃ§os</button>
  <button data-tab="orcamento">ðŸ“‹ OrÃ§amento</button>
  <button data-tab="historico">ðŸ“œ HistÃ³rico</button>
</nav>

<section id="clientes" class="active">
  <h2>Cadastro de Clientes</h2>
  <form id="form-clientes">
    <input type="text" id="nome" placeholder="Nome" required />
    <input type="tel" id="telefone" placeholder="Telefone" />
    <input type="text" id="carro" placeholder="Carro" />
    <input type="text" id="placa" placeholder="Placa" />
    <button type="submit">Salvar Cliente</button>
  </form>
  <ul id="lista-clientes"></ul>
</section>

<section id="servicos">
  <h2>Cadastro de ServiÃ§os</h2>
  <form id="form-servicos">
    <input type="text" id="descricao" placeholder="DescriÃ§Ã£o" required />
    <input type="number" id="valor" placeholder="Valor R$" step="0.01" required />
    <button type="submit">Salvar ServiÃ§o</button>
  </form>
  <ul id="lista-servicos"></ul>
</section>

<section id="orcamento">
  <h2>Gerar OrÃ§amento</h2>
  <form id="form-orcamento">
    <select id="select-cliente" required></select>
    <select id="select-servico" required></select>
    <input type="number" id="desconto" placeholder="Desconto (%)" />
    <button type="submit">Salvar OrÃ§amento</button>
  </form>
</section>

<section id="historico">
  <h2>HistÃ³rico de OrÃ§amentos</h2>
  <ul id="lista-orcamentos"></ul>
  <pre class="orcamento-box" id="orcamento-box"></pre>
  <button id="btnSalvarOrcamento">Salvar OrÃ§amento ðŸ’¾</button>
  <button id="btnEnviarOrcamento">Enviar WhatsApp ðŸ“¤</button>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    'https://zkdfimbfwgofkmmcvyfu.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  );

  const tabs = document.querySelectorAll('nav button');
  const sections = document.querySelectorAll('section');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const alvo = tab.dataset.tab;
      sections.forEach(s => s.id === alvo ? s.classList.add('active') : s.classList.remove('active'));
    });
  });

  async function carregarClientes() {
    const { data } = await supabase.from('clientes').select('*').order('nome');
    const lista = document.getElementById('lista-clientes');
    const select = document.getElementById('select-cliente');
    lista.innerHTML = '';
    select.innerHTML = '<option value="">Selecione o cliente</option>';
    data.forEach(c => {
      lista.innerHTML += `<li>${c.nome} ${c.carro || ''} (${c.placa || ''})</li>`;
      select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    });
  }

  async function carregarServicos() {
    const { data } = await supabase.from('servicos').select('*').order('descricao');
    const lista = document.getElementById('lista-servicos');
    const select = document.getElementById('select-servico');
    lista.innerHTML = '';
    select.innerHTML = '<option value="">Selecione o serviÃ§o</option>';
    data.forEach(s => {
      lista.innerHTML += `<li>${s.descricao} - R$ ${s.valor.toFixed(2)}</li>`;
      select.innerHTML += `<option value="${s.id}">${s.descricao}</option>`;
    });
  }

  async function carregarOrcamentos() {
    const { data } = await supabase.from('orcamentos').select(`
      id, desconto, created_at,
      clientes (nome, carro, placa),
      servicos (descricao, valor)
    `).order('created_at', { ascending: false });

    const lista = document.getElementById('lista-orcamentos');
    lista.innerHTML = '';
    data.forEach(o => {
      const total = o.servicos.valor * (1 - (o.desconto || 0) / 100);
      const texto =
`ðŸ§¾ R.M. EstÃ©tica Automotiva ðŸ§¾
Data: ${new Date(o.created_at).toLocaleString()}
Cliente: ${o.clientes.nome}
Carro: ${o.clientes.carro} (${o.clientes.placa})
ServiÃ§o: ${o.servicos.descricao}
Valor: R$ ${o.servicos.valor.toFixed(2)}
Desconto: ${o.desconto || 0}%
Total: R$ ${total.toFixed(2)}`;

      lista.innerHTML += `<li>
        ${o.clientes.nome} - ${o.servicos.descricao}
        <button onclick="document.getElementById('orcamento-box').textContent=\`${texto}\`">Ver</button>
      </li>`;
    });
  }

  document.getElementById('form-clientes').addEventListener('submit', async e => {
    e.preventDefault();
    const { nome, telefone, carro, placa } = e.target;
    await supabase.from('clientes').insert([{ nome: nome.value, telefone: telefone.value, carro: carro.value, placa: placa.value }]);
    e.target.reset();
    carregarClientes();
  });

  document.getElementById('form-servicos').addEventListener('submit', async e => {
    e.preventDefault();
    const { descricao, valor } = e.target;
    await supabase.from('servicos').insert([{ descricao: descricao.value, valor: parseFloat(valor.value) }]);
    e.target.reset();
    carregarServicos();
  });

  document.getElementById('form-orcamento').addEventListener('submit', async e => {
    e.preventDefault();
    const clienteId = parseInt(document.getElementById('select-cliente').value);
    const servicoId = parseInt(document.getElementById('select-servico').value);
    const desconto = parseFloat(document.getElementById('desconto').value || 0);
    await supabase.from('orcamentos').insert([{ cliente_id: clienteId, servico_id: servicoId, desconto }]);
    e.target.reset();
    carregarOrcamentos();
  });

  document.getElementById('btnSalvarOrcamento').addEventListener('click', () => {
    const texto = document.getElementById('orcamento-box').textContent;
    if (!texto) return;
    const blob = new Blob([texto], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'orcamento.txt';
    a.click();
  });

  document.getElementById('btnEnviarOrcamento').addEventListener('click', () => {
    const texto = document.getElementById('orcamento-box').textContent;
    if (!texto) return;
    const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
    window.open(url, '_blank');
  });

  carregarClientes();
  carregarServicos();
  carregarOrcamentos();
</script>
</body>
</html>
