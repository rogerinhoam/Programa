<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestão R.M. Estética Automotiva</title>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #eee; margin: 0; padding: 0; }
  header { background: #990000; padding: 10px; }
  nav button { background: #cc3333; color: white; border: none; padding: 10px 15px; margin-right: 5px; cursor: pointer; font-weight: bold; }
  nav button:hover { background: #ff5555; }
  .aba { display: none; padding: 15px; }
  .aba.active { display: block; }
  label { display: block; margin-top: 10px; }
  input[type=text], input[type=number] { width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
  button[type=submit] { margin-top: 15px; background: #cc3333; border: none; padding: 10px 20px; color: white; font-weight: bold; border-radius: 4px; cursor: pointer; }
  button[type=submit]:hover { background: #ff5555; }
  #listaClientes div, #listaServicos div, #listaHistorico div { background: #222; padding: 10px; margin-top: 8px; border-radius: 4px; cursor: pointer; }
  #listaClientes div:hover, #listaServicos div:hover, #listaHistorico div:hover { background: #333; }
  .btn-pequeno { background: #cc3333; border: none; color: white; padding: 4px 8px; margin-left: 5px; cursor: pointer; border-radius: 3px; }
  .btn-pequeno:hover { background: #ff5555; }
  #cupom { white-space: pre-wrap; background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; font-family: monospace; }
</style>
</head>
<body>

<header>
  <nav>
    <button id="menuClientes">Clientes</button>
    <button id="menuServicos">Serviços</button>
    <button id="menuOrcamentos">Orçamentos</button>
    <button id="menuHistorico">Histórico</button>
  </nav>
</header>

<!-- Abas -->
<div id="clientes" class="aba active">
  <h2>Clientes</h2>
  <form id="formCliente">
    <input type="hidden" id="inputClienteId" />
    <label>Nome:</label>
    <input type="text" id="inputNomeCliente" required />
    
    <label>Telefone:</label>
    <input type="text" id="inputTelefoneCliente" />
    
    <label>Carro:</label>
    <input type="text" id="inputCarroCliente" />
    
    <label>Placa:</label>
    <input type="text" id="inputPlacaCliente" />
    
    <button type="submit">Salvar Cliente</button>
  </form>
  <div id="listaClientes"></div>
</div>

<div id="servicos" class="aba">
  <h2>Serviços</h2>
  <form id="formServico">
    <input type="hidden" id="inputServicoId" />
    <label>Descrição:</label>
    <input type="text" id="inputDescricaoServico" required />
    
    <label>Valor (R$):</label>
    <input type="number" id="inputValorServico" required min="0" step="0.01" />
    
    <button type="submit">Salvar Serviço</button>
  </form>
  <div id="listaServicos"></div>
</div>

<div id="orcamentos" class="aba">
  <h2>Orçamentos</h2>
  <form id="formOrcamento">
    <label>Cliente:</label>
    <select id="clienteSelect" required>
      <option value="">Selecione um cliente</option>
    </select>

    <label>Serviço:</label>
    <select id="servicoSelect" required>
      <option value="">Selecione um serviço</option>
    </select>

    <label>Carro:</label>
    <input type="text" id="carroOrcamento" required />

    <label>Desconto (%):</label>
    <input type="number" id="descontoOrcamento" min="0" max="100" step="0.1" value="0" />

    <fieldset style="margin-top:10px;">
      <legend>Formas de pagamento (selecione ao menos uma):</legend>
      <label><input type="checkbox" name="pagamento" value="Dinheiro" /> Dinheiro</label>
      <label><input type="checkbox" name="pagamento" value="Pix" /> Pix</label>
      <label><input type="checkbox" name="pagamento" value="Cartão" /> Cartão</label>
    </fieldset>

    <button type="submit">Gerar Orçamento</button>
  </form>

  <pre id="cupom"></pre>
  
  <button id="btnPdf" style="margin-top:10px;">Salvar como PDF</button>
  <button id="btnWhats">Enviar pelo WhatsApp</button>
</div>

<div id="historico" class="aba">
  <h2>Histórico de Orçamentos</h2>
  <div id="listaHistorico"></div>
</div>

<script type="module">
// --- Configuração Supabase ---
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://zkdfimbfwgofkmmcvyfu.supabase.co';  // troque se necessário
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE';
const supabase = createClient(supabaseUrl, supabaseKey);

// --- Navegação entre abas ---
function mostrarAba(nomeAba) {
  document.querySelectorAll('.aba').forEach(aba => {
    aba.classList.toggle('active', aba.id === nomeAba);
  });
}
document.getElementById('menuClientes').onclick = () => mostrarAba('clientes');
document.getElementById('menuServicos').onclick = () => mostrarAba('servicos');
document.getElementById('menuOrcamentos').onclick = () => mostrarAba('orcamentos');
document.getElementById('menuHistorico').onclick = () => mostrarAba('historico');

// --- Clientes ---
const formCliente = document.getElementById('formCliente');
const inputClienteId = document.getElementById('inputClienteId');
const inputNomeCliente = document.getElementById('inputNomeCliente');
const inputTelefoneCliente = document.getElementById('inputTelefoneCliente');
const inputCarroCliente = document.getElementById('inputCarroCliente');
const inputPlacaCliente = document.getElementById('inputPlacaCliente');
const listaClientes = document.getElementById('listaClientes');

async function carregarClientes() {
  const { data, error } = await supabase.from('clientes').select('*').order('id', { ascending: true });
  if (error) {
    alert('Erro ao carregar clientes: ' + error.message);
    return;
  }
  listaClientes.innerHTML = '';
  const clienteSelect = document.getElementById('clienteSelect');
  clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';
  data.forEach(cliente => {
    // Lista no painel
    const div = document.createElement('div');
    div.textContent = `${cliente.nome} - ${cliente.carro || '-'} (${cliente.placa || '-'})`;
    div.onclick = () => {
      inputClienteId.value = cliente.id;
      inputNomeCliente.value = cliente.nome;
      inputTelefoneCliente.value = cliente.telefone || '';
      inputCarroCliente.value = cliente.carro || '';
      inputPlacaCliente.value = cliente.placa || '';
      mostrarAba('clientes');
    };
    listaClientes.appendChild(div);
    // Lista no select do orçamento
    const option = document.createElement('option');
    option.value = cliente.id;
    option.textContent = cliente.nome;
    clienteSelect.appendChild(option);
  });
}

formCliente.addEventListener('submit', async e => {
  e.preventDefault();
  const id = inputClienteId.value;
  const nome = inputNomeCliente.value.trim();
  const telefone = inputTelefoneCliente.value.trim();
  const carro = inputCarroCliente.value.trim();
  const placa = inputPlacaCliente.value.trim();

  if (!nome) {
    alert('Preencha o nome do cliente');
    return;
  }

  if (id) {
    const { error } = await supabase.from('clientes').update({ nome, telefone, carro, placa }).eq('id', id);
    if (error) alert('Erro ao atualizar cliente: ' + error.message);
    else {
      alert('Cliente atualizado!');
      formCliente.reset();
      inputClienteId.value = '';
      carregarClientes();
    }
  } else {
    const { error } = await supabase.from('clientes').insert({ nome, telefone, carro, placa });
    if (error) alert('Erro ao cadastrar cliente: ' + error.message);
    else {
      alert('Cliente cadastrado!');
      formCliente.reset();
      carregarClientes();
    }
  }
});

// --- Serviços ---
const formServico = document.getElementById('formServico');
const inputServicoId = document.getElementById('inputServicoId');
const inputDescricaoServico = document.getElementById('inputDescricaoServico');
const inputValorServico = document.getElementById('inputValorServico');
const listaServicos = document.getElementById('listaServicos');

async function carregarServicos() {
  const { data, error } = await supabase.from('servicos').select('*').order('id', { ascending: true });
  if (error) {
    alert('Erro ao carregar serviços: ' + error.message);
    return;
  }
  listaServicos.innerHTML = '';
  const servicoSelect = document.getElementById('servicoSelect');
  servicoSelect.innerHTML = '<option value="">Selecione um serviço</option>';
  data.forEach(servico => {
    // Lista no painel
    const div = document.createElement('div');
    div.textContent = `${servico.descricao} — R$ ${servico.valor.toFixed(2)}`;
    div.onclick = () => {
      inputServicoId.value = servico.id;
      inputDescricaoServico.value = servico.descricao;
      inputValorServico.value = servico.valor;
      mostrarAba('servicos');
    };
    listaServicos.appendChild(div);
    // Lista no select do orçamento
    const option = document.createElement('option');
    option.value = servico.id;
    option.textContent = servico.descricao;
    servicoSelect.appendChild(option);
  });
}

formServico.addEventListener('submit', async e => {
  e.preventDefault();
  const id = inputServicoId.value;
  const descricao = inputDescricaoServico.value.trim();
  const valor = parseFloat(inputValorServico.value);

  if (!descricao || isNaN(valor)) {
    alert('Preencha todos os campos corretamente!');
    return;
  }

  if (id) {
    const { error } = await supabase.from('servicos').update({ descricao, valor }).eq('id', id);
    if (error) alert('Erro ao atualizar serviço: ' + error.message);
    else {
      alert('Serviço atualizado!');
      formServico.reset();
      inputServicoId.value = '';
      carregarServicos();
    }
  } else {
    const { error } = await supabase.from('servicos').insert({ descricao, valor });
    if (error) alert('Erro ao cadastrar serviço: ' + error.message);
    else {
      alert('Serviço cadastrado!');
      formServico.reset();
      carregarServicos();
    }
  }
});

// --- Orçamentos ---
const formOrcamento = document.getElementById('formOrcamento');
const inputClienteSelect = document.getElementById('clienteSelect');
const inputServicoSelect = document.getElementById('servicoSelect');
const inputCarroOrcamento = document.getElementById('carroOrcamento');
const inputDescontoOrcamento = document.getElementById('descontoOrcamento');
const cupomEl = document.getElementById('cupom');

function formatarData(data) {
  return data.toLocaleDateString('pt-BR') + ', ' + data.toLocaleTimeString('pt-BR');
}

function gerarCupom(orcamento, cliente, servico) {
  const data = new Date(orcamento.created_at || new Date());
  const desconto = orcamento.desconto || 0;
  const valorComDesconto = servico.valor * (1 - desconto / 100);
  const formasPagto = orcamento.forma_pagamento.split(',').join(', ');

  return `
� Orçamento R.M. Estética Automotiva �

==============================
       R.M. ESTÉTICA AUTOMOTIVA
==============================
Data: ${formatarData(data)}       
Cliente: ${cliente.nome}
Carro: ${orcamento.carro || '-'}
------------------------------
SERVIÇOS:
- ${servico.descricao}  R$ ${servico.valor.toFixed(2)}
------------------------------
Desconto: ${desconto.toFixed(2)}%
Total: R$ ${valorComDesconto.toFixed(2)}
Forma(s) de Pagamento: ${formasPagto}
------------------------------
LOJA PARA CONTATO:
Tel: 24 999486232
Endereço:
Rua 40, Travessa Recanto dos Pássaros
==============================
    Obrigado pela preferência!
==============================


� Entre em contato conosco para agendar seu serviço!
Obrigado pela preferência! �
  `.trim();
}

formOrcamento.addEventListener('submit', async e => {
  e.preventDefault();

  const cliente_id = inputClienteSelect.value;
  const servico_id = inputServicoSelect.value;
  const carro = inputCarroOrcamento.value.trim();
  const desconto = parseFloat(inputDescontoOrcamento.value) || 0;
  const pagamentoChecks = Array.from(document.querySelectorAll('input[name="pagamento"]:checked'));

  if (!cliente_id || !servico_id || !carro || pagamentoChecks.length === 0) {
    alert('Preencha todos os campos e selecione pelo menos uma forma de pagamento!');
    return;
  }

  const forma_pagamento = pagamentoChecks.map(i => i.value).join(',');

  const { data: orcamento, error } = await supabase.from('orcamentos').insert({
    cliente_id,
    servico_id,
    carro,
    desconto,
    forma_pagamento,
  }).select().single();

  if (error) {
    alert('Erro ao salvar orçamento: ' + error.message);
    return;
  }

  // Buscar cliente e serviço para cupom
  const { data: cliente } = await supabase.from('clientes').select('*').eq('id', cliente_id).single();
  const { data: servico } = await supabase.from('servicos').select('*').eq('id', servico_id).single();

  const cupom = gerarCupom(orcamento, cliente, servico);
  cupomEl.textContent = cupom;
  alert('Orçamento salvo e cupom gerado!');
  mostrarAba('orcamentos');
});

// --- Histórico ---
const listaHistorico = document.getElementById('listaHistorico');

async function carregarHistorico() {
  const { data: orcamentos, error } = await supabase
    .from('orcamentos')
    .select('*, clientes(*), servicos(*)')
    .order('id', { ascending: false });

  if (error) {
    alert('Erro ao carregar histórico: ' + error.message);
    return;
  }

  listaHistorico.innerHTML = '';
  orcamentos.forEach(orc => {
    const cliente = orc.clientes;
    const servico = orc.servicos;
    const div = document.createElement('div');
    div.className = 'list-item';
    div.textContent = `#${orc.id} - ${cliente.nome} - ${servico.descricao}`;

    // Botão visualizar cupom
    const btnVisualizar = document.createElement('button');
    btnVisualizar.textContent = '📄';
    btnVisualizar.title = 'Visualizar Cupom';
    btnVisualizar.onclick = () => {
      const cupom = gerarCupom(orc, cliente, servico);
      cupomEl.textContent = cupom;
      mostrarAba('orcamentos');
    };

    // Botão excluir
    const btnExcluir = document.createElement('button');
    btnExcluir.textContent = '🗑️';
    btnExcluir.title = 'Excluir Orçamento';
    btnExcluir.onclick = async () => {
      if (confirm(`Excluir orçamento #${orc.id}?`)) {
        const { error } = await supabase.from('orcamentos').delete().eq('id', orc.id);
        if (error) alert('Erro ao excluir: ' + error.message);
        else carregarHistorico();
      }
    };

    div.appendChild(btnVisualizar);
    div.appendChild(btnExcluir);
    listaHistorico.appendChild(div);
  });
}

// --- PDF e WhatsApp ---
document.getElementById('btnPdf').onclick = () => {
  const texto = cupomEl.textContent;
  if (!texto) return alert('Nenhum cupom para salvar.');
  const blob = new Blob([texto], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'orcamento.pdf';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('btnWhats').onclick = () => {
  const texto = encodeURIComponent(cupomEl.textContent);
  if (!texto) return alert('Nenhum cupom para enviar.');
  const url = `https://api.whatsapp.com/send?text=${texto}`;
  window.open(url, '_blank');
};

// --- Inicialização ---
window.onload = () => {
  carregarClientes();
  carregarServicos();
  carregarHistorico();
};
</script>

</body>
</html>
