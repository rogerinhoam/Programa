<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>R.M. Est√©tica Automotiva - Gest√£o Completa</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#b30000">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      :root {
        --bg-primary: #1a1a1a; --bg-secondary: #2a2a2a; --bg-tertiary: #3a3a3a;
        --text-primary: #f0e6d2; --text-secondary: #c9bda8; --accent-primary: #b30000;
        --accent-secondary: #ff4d4d; --accent-highlight: #ffdb85; --font-family: 'Inter', sans-serif;
        --border-radius: 8px; --transition-speed: 0.3s;
      }
      body { background: var(--bg-primary); color: var(--text-primary); font-family: var(--font-family); margin: 0; padding: 0; }
      header { background: var(--accent-primary); color: var(--accent-highlight); padding: 16px 20px; text-align: center; font-size: 26px; font-weight: 700; letter-spacing: 2px; border-bottom: 2px solid var(--accent-highlight); }
      nav { display: flex; background: var(--bg-secondary); justify-content: center; padding: 8px; gap: 10px; }
      nav button { background: transparent; color: var(--text-secondary); border: 2px solid transparent; padding: 10px 20px; cursor: pointer; font-weight: 600; border-radius: var(--border-radius); transition: all var(--transition-speed) ease; }
      nav button.active, nav button:hover { background: var(--accent-primary); color: var(--accent-highlight); border-color: var(--accent-highlight); }
      main { padding: 20px; max-width: 900px; margin: auto; }
      .search-container { margin-bottom: 15px; }
      .search-container input { width: 100%; padding: 10px 15px; background-color: var(--bg-secondary); border: 1px solid var(--bg-tertiary); color: var(--text-primary); border-radius: var(--border-radius); font-size: 16px; }
      .item-list { list-style: none; padding: 0; margin: 10px 0 30px 0; border: 1px solid var(--bg-tertiary); border-radius: var(--border-radius); background: var(--bg-secondary); }
      .item-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--bg-tertiary); transition: background-color var(--transition-speed) ease; }
      .item-list li:hover { background-color: var(--bg-tertiary); }
      .item-list li:last-child { border-bottom: none; }
      .item-info { flex-grow: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 15px; }
      .item-actions { display: flex; gap: 10px; }
      .item-actions button { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; transition: color var(--transition-speed) ease; }
      .item-actions button:hover { color: var(--accent-highlight); }
      .item-actions svg { width: 20px; height: 20px; pointer-events: none; }
      form { background: var(--bg-secondary); padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; border: 1px solid var(--bg-tertiary); }
      form label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
      form input, form select { width: 100%; padding: 10px 12px; margin-bottom: 16px; border: 1px solid var(--bg-tertiary); background-color: var(--bg-primary); color: var(--text-primary); border-radius: var(--border-radius); font-size: 16px; }
      form input:focus, form select:focus { outline: none; border-color: var(--accent-highlight); }
      .checkbox-group { margin-bottom: 16px; }
      .checkbox-group label { font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
      .checkbox-container { display: flex; flex-wrap: wrap; gap: 15px; }
      .checkbox-item { display: flex; align-items: center; gap: 8px; }
      .checkbox-item input[type="checkbox"] { width: auto; margin-bottom: 0; }
      .checkbox-item span { font-weight: 500; }
      form button[type=submit] { background: var(--accent-primary); color: var(--accent-highlight); border: none; padding: 12px 20px; cursor: pointer; font-weight: 700; font-size: 16px; border-radius: var(--border-radius); transition: background-color var(--transition-speed) ease; }
      form button[type=submit]:hover { background: var(--accent-secondary); }
      form button[type=submit]:disabled { background-color: var(--bg-tertiary); cursor: not-allowed; color: var(--text-secondary); }
      #historico-texto { white-space: pre-wrap; background: var(--bg-secondary); padding: 20px; border-radius: var(--border-radius); font-family: 'Courier New', Courier, monospace; font-size: 14px; line-height: 1.5; max-height: 400px; overflow-y: auto; border: 1px solid var(--bg-tertiary); }
      .btn-group { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .btn-group button { background: var(--accent-primary); color: var(--accent-highlight); border: none; padding: 12px 16px; cursor: pointer; font-weight: 600; border-radius: var(--border-radius); transition: background-color var(--transition-speed) ease; }
      .btn-group button:hover { background: var(--accent-secondary); }
      .btn-group button:disabled { background: var(--bg-tertiary); cursor: not-allowed; color: var(--text-secondary); }
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all var(--transition-speed) ease; z-index: 2000; }
      .modal-overlay.visible { opacity: 1; visibility: visible; }
      .modal-content { background: var(--bg-secondary); padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 400px; text-align: center; transform: scale(0.9); transition: all var(--transition-speed) ease; }
      .modal-overlay.visible .modal-content { transform: scale(1); }
      .modal-content p { margin: 0 0 20px; font-size: 18px; }
      .modal-buttons { display: flex; gap: 15px; justify-content: center;}
      .modal-buttons button { border: none; padding: 10px 25px; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed); }
      #modal-confirm-btn { background: var(--accent-secondary); color: white; }
      #modal-cancel-btn { background: var(--bg-tertiary); color: var(--text-primary); }
      #toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 3000; }
      .toast { padding: 15px 20px; border-radius: var(--border-radius); color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, slideOut 0.5s 4s forwards; }
      .toast.success { background-color: #28a745; }
      .toast.error { background-color: var(--accent-secondary); }
      @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
      @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
      .hidden { display: none; }
      @media(max-width:600px){ nav { flex-wrap: wrap; } .btn-group { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>R.M. Est√©tica Automotiva</header>

<nav>
  <button class="active" data-tab="clientes">Clientes</button>
  <button data-tab="servicos">Servi√ßos</button>
  <button data-tab="orcamentos">Or√ßamentos</button>
  <button data-tab="historico">Hist√≥rico</button>
</nav>

<main>
  <section id="clientes" class="tab-content">
    <form id="form-cliente">
      <input type="hidden" id="cliente-id" />
      <label for="cliente-nome">Nome</label>
      <input type="text" id="cliente-nome" required />
      <label for="cliente-telefone">Telefone</label>
      <input type="text" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX"/>
      <label for="cliente-carro">Carro</label>
      <input type="text" id="cliente-carro" placeholder="Ex: Honda Civic" />
      <label for="cliente-placa">Placa</label>
      <input type="text" id="cliente-placa" placeholder="ABC-1234"/>
      <button type="submit">Salvar Cliente</button>
    </form>
    <div class="search-container">
      <input type="search" id="search-clientes" placeholder="üîé Buscar cliente por nome, carro ou placa...">
    </div>
    <ul id="lista-clientes" class="item-list"></ul>
  </section>

  <section id="servicos" class="tab-content hidden">
    <form id="form-servico">
      <input type="hidden" id="servico-id" />
      <label for="servico-descricao">Descri√ß√£o</label>
      <input type="text" id="servico-descricao" required />
      <label for="servico-valor">Valor (R$)</label>
      <input type="number" step="0.01" id="servico-valor" required />
      <button type="submit">Salvar Servi√ßo</button>
    </form>
    <div class="search-container">
        <input type="search" id="search-servicos" placeholder="üîé Buscar servi√ßo...">
    </div>
    <ul id="lista-servicos" class="item-list"></ul>
  </section>

  <section id="orcamentos" class="tab-content hidden">
    <form id="form-orcamento">
      <label for="orcamento-cliente">Cliente</label>
      <select id="orcamento-cliente" required><option value="">Selecione um cliente</option></select>
      <label for="orcamento-servico">Servi√ßo</label>
      <select id="orcamento-servico" required><option value="">Selecione um servi√ßo</option></select>
      <label for="orcamento-desconto">Desconto (%)</label>
      <input type="number" id="orcamento-desconto" value="0" min="0" max="100" />
      <div class="checkbox-group">
          <label>Formas de Pagamento Aceitas</label>
          <div class="checkbox-container">
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Pix"><span>Pix</span></div>
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Dinheiro"><span>Dinheiro</span></div>
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Cart√£o de Cr√©dito"><span>Cart√£o de Cr√©dito</span></div>
              <div class="checkbox-item"><input type="checkbox" name="pagamento" value="Cart√£o de D√©bito"><span>Cart√£o de D√©bito</span></div>
          </div>
      </div>
      <button type="submit">Salvar Or√ßamento</button>
    </form>
    <ul id="lista-orcamentos" class="item-list"></ul>
  </section>

  <section id="historico" class="tab-content hidden">
    <pre id="historico-texto">Selecione um or√ßamento na aba "Or√ßamentos" para ver os detalhes aqui.</pre>
    <div class="btn-group">
      <button id="btn-gerar-orcamento-pdf" disabled>Gerar Or√ßamento (PDF)</button>
      <button id="btn-enviar-orcamento-whatsapp" disabled>Enviar Or√ßamento (WhatsApp)</button>
      <button id="btn-gerar-recibo-pdf" disabled>Gerar Recibo de Servi√ßo (PDF)</button>
      <button id="btn-enviar-recibo-whatsapp" disabled>Enviar Recibo (WhatsApp)</button>
    </div>
  </section>
</main>

<div id="modal-confirm" class="modal-overlay">
  <div class="modal-content">
    <p id="modal-text">Voc√™ tem certeza?</p>
    <div class="modal-buttons">
      <button id="modal-cancel-btn">Cancelar</button>
      <button id="modal-confirm-btn">Confirmar</button>
    </div>
  </div>
</div>
<div id="toast-container"></div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('Service Worker registrado com sucesso:', registration))
                .catch(error => console.error('Falha ao registrar Service Worker:', error));
        });
    }
</script>

<script type="module">
    const { jsPDF } = window.jspdf;
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- CONFIGURA√á√ÉO E ESTADO ---
    const supabaseUrl = 'https://zkdfimbfwgofkmmcvyfu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const state = {
        clientes: [], servicos: [], orcamentos: [],
        orcamentoAtual: null, textoOrcamentoAtual: '', textoReciboAtual: '',
    };

    const DOMElements = {
        nav: document.querySelector('nav'),
        tabs: document.querySelectorAll('nav button'),
        tabContents: document.querySelectorAll('.tab-content'),
        formCliente: document.getElementById('form-cliente'),
        formServico: document.getElementById('form-servico'),
        formOrcamento: document.getElementById('form-orcamento'),
        listaClientes: document.getElementById('lista-clientes'),
        listaServicos: document.getElementById('lista-servicos'),
        listaOrcamentos: document.getElementById('lista-orcamentos'),
        searchClientes: document.getElementById('search-clientes'),
        searchServicos: document.getElementById('search-servicos'),
        selectCliente: document.getElementById('orcamento-cliente'),
        selectServico: document.getElementById('orcamento-servico'),
        historicoTexto: document.getElementById('historico-texto'),
        btnGerarOrcamentoPDF: document.getElementById('btn-gerar-orcamento-pdf'),
        btnEnviarOrcamentoWhats: document.getElementById('btn-enviar-orcamento-whatsapp'),
        btnGerarReciboPDF: document.getElementById('btn-gerar-recibo-pdf'),
        btnEnviarReciboWhats: document.getElementById('btn-enviar-recibo-whatsapp'),
        modal: document.getElementById('modal-confirm'),
        modalText: document.getElementById('modal-text'),
        modalConfirmBtn: document.getElementById('modal-confirm-btn'),
        modalCancelBtn: document.getElementById('modal-cancel-btn'),
        toastContainer: document.getElementById('toast-container'),
    };

    const icons = {
        edit: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M17.293 2.293a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-13 13A1 1 0 0 1 8 20H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 .293-.707l13-13zM16 5.414l-9 9V18h3.586l9-9L16 5.414z"/></svg>`,
        delete: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm13-15H5l1-1h12l1 1zM4 5h16v2H4V5z"/></svg>`,
        view: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-2 16H8v-2h4v2zm0-4H8v-2h4v2zm4-4H8V8h8v2z"/></svg>`
    };

    // --- FUN√á√ïES UTILIT√ÅRIAS ---
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        DOMElements.toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4500);
    }

    function showConfirmationModal(message, onConfirm) {
        DOMElements.modalText.textContent = message;
        DOMElements.modal.classList.add('visible');
        const newConfirmBtn = DOMElements.modalConfirmBtn.cloneNode(true);
        DOMElements.modalConfirmBtn.replaceWith(newConfirmBtn);
        DOMElements.modalConfirmBtn = newConfirmBtn;
        const close = () => DOMElements.modal.classList.remove('visible');
        DOMElements.modalConfirmBtn.onclick = () => { close(); onConfirm(); };
        DOMElements.modalCancelBtn.onclick = close;
    }

    function setFormLoading(form, isLoading) {
        const button = form.querySelector('button[type=submit]');
        if (!button) return;
        const originalText = button.dataset.originalText || button.textContent;
        if (isLoading) {
            button.dataset.originalText = originalText;
            button.disabled = true;
            button.textContent = 'Salvando...';
        } else {
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    function setHistoryButtonsState(enabled) {
        DOMElements.btnGerarOrcamentoPDF.disabled = !enabled;
        DOMElements.btnEnviarOrcamentoWhats.disabled = !enabled;
        DOMElements.btnGerarReciboPDF.disabled = !enabled;
        DOMElements.btnEnviarReciboWhats.disabled = !enabled;
    }

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
    function renderClientes(filter = '') {
        const lowerFilter = filter.toLowerCase();
        const filtered = state.clientes.filter(c => c.nome.toLowerCase().includes(lowerFilter) || (c.carro || '').toLowerCase().includes(lowerFilter) || (c.placa || '').toLowerCase().includes(lowerFilter));
        DOMElements.listaClientes.innerHTML = filtered.map(c => `<li data-id="${c.id}"><div class="item-info">${c.nome} ‚Äî ${c.carro || '-'} ‚Äî ${c.placa || '-'}</div><div class="item-actions"><button title="Editar" data-action="edit">${icons.edit}</button><button title="Excluir" data-action="delete">${icons.delete}</button></div></li>`).join('') || `<li style="justify-content: center;">Nenhum cliente encontrado.</li>`;
    }

    function renderServicos(filter = '') {
        const lowerFilter = filter.toLowerCase();
        const filtered = state.servicos.filter(s => s.descricao.toLowerCase().includes(lowerFilter));
        DOMElements.listaServicos.innerHTML = filtered.map(s => `<li data-id="${s.id}"><div class="item-info">${s.descricao} ‚Äî R$ ${parseFloat(s.valor).toFixed(2)}</div><div class="item-actions"><button title="Editar" data-action="edit">${icons.edit}</button><button title="Excluir" data-action="delete">${icons.delete}</button></div></li>`).join('') || `<li style="justify-content: center;">Nenhum servi√ßo encontrado.</li>`;
    }

    function renderOrcamentos() {
        DOMElements.listaOrcamentos.innerHTML = state.orcamentos.map(o => {
            if (!o.clientes || !o.servicos) return ''; // Prote√ß√£o contra dados √≥rf√£os
            const total = o.servicos.valor * (1 - (o.desconto || 0) / 100);
            return `<li data-id="${o.id}"><div class="item-info">${o.clientes.nome} ‚Äî ${o.servicos.descricao} ‚Äî Total: R$ ${total.toFixed(2)}</div><div class="item-actions"><button title="Ver Detalhes" data-action="view">${icons.view}</button><button title="Excluir" data-action="delete">${icons.delete}</button></div></li>`;
        }).join('') || `<li style="justify-content: center;">Nenhum or√ßamento salvo.</li>`;
    }

    function renderSelectOptions(selectElement, items, valueField, textField) {
        const currentValue = selectElement.value;
        const placeholder = selectElement.querySelector('option[value=""]');
        selectElement.innerHTML = '';
        if (placeholder) selectElement.appendChild(placeholder);
        items.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item[valueField];
            opt.textContent = typeof textField === 'function' ? textField(item) : item[textField];
            selectElement.appendChild(opt);
        });
        selectElement.value = currentValue;
    }

    // --- L√ìGICA DE DADOS (API) ---
    async function fetchData(tableName, orderOptions) {
        try {
            const { data, error } = await supabase.from(tableName).select('*').order(orderOptions.column, { ascending: orderOptions.ascending });
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error(`Erro ao carregar ${tableName}:`, error);
            showToast(`Erro de rede ao carregar ${tableName}.`, 'error');
            return [];
        }
    }

    async function fetchOrcamentos() {
        try {
            const { data, error } = await supabase.from('orcamentos').select(`*, clientes(*), servicos(*)`).order('created_at', { ascending: false });
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Erro ao carregar or√ßamentos:', error);
            showToast('Erro de rede ao carregar or√ßamentos.', 'error');
            return [];
        }
    }

    async function loadAndRenderAll() {
        state.clientes = await fetchData('clientes', { column: 'nome', ascending: true });
        state.servicos = await fetchData('servicos', { column: 'descricao', ascending: true });
        state.orcamentos = await fetchOrcamentos();
        renderAll();
    }

    function renderAll() {
        renderClientes(DOMElements.searchClientes.value);
        renderServicos(DOMElements.searchServicos.value);
        renderOrcamentos();
        renderSelectOptions(DOMElements.selectCliente, state.clientes, 'id', c => `${c.nome} (${c.carro || '-'})`);
        renderSelectOptions(DOMElements.selectServico, state.servicos, 'id', s => `${s.descricao} ‚Äî R$ ${parseFloat(s.valor).toFixed(2)}`);
    }

    // --- HANDLERS DE A√á√ïES (EVENTOS) ---
    async function handleSaveCliente(e) {
        e.preventDefault();
        const form = DOMElements.formCliente; setFormLoading(form, true);
        const id = form['cliente-id'].value;
        const clienteData = { nome: form['cliente-nome'].value.trim(), telefone: form['cliente-telefone'].value.trim(), carro: form['cliente-carro'].value.trim(), placa: form['cliente-placa'].value.trim() };
        if (!clienteData.nome) { showToast('Nome √© obrigat√≥rio', 'error'); setFormLoading(form, false); return; }
        try {
            const { error } = id ? await supabase.from('clientes').update(clienteData).eq('id', id) : await supabase.from('clientes').insert(clienteData);
            if (error) throw error;
            showToast(`Cliente ${id ? 'atualizado' : 'cadastrado'}!`, 'success');
            form.reset();
            form['cliente-id'].value = '';
            await loadAndRenderAll();
        } catch (error) {
            console.error('Erro ao salvar cliente:', error);
            showToast(`Erro ao salvar cliente: ${error.message}`, 'error');
        } finally {
            setFormLoading(form, false);
        }
    }

    function handleEditCliente(id) {
        const cliente = state.clientes.find(c => c.id == id);
        if (!cliente) return;
        const form = DOMElements.formCliente;
        form['cliente-id'].value = cliente.id; form['cliente-nome'].value = cliente.nome; form['cliente-telefone'].value = cliente.telefone; form['cliente-carro'].value = cliente.carro; form['cliente-placa'].value = cliente.placa;
        DOMElements.nav.querySelector('[data-tab="clientes"]').click();
        form['cliente-nome'].focus();
    }

    async function handleSaveServico(e) {
        e.preventDefault();
        const form = DOMElements.formServico; setFormLoading(form, true);
        const id = form['servico-id'].value;
        const valor = parseFloat(form['servico-valor'].value);
        const servicoData = { descricao: form['servico-descricao'].value.trim(), valor: isNaN(valor) ? 0 : valor };
        if (!servicoData.descricao || servicoData.valor <= 0) { showToast('Descri√ß√£o e valor v√°lido s√£o obrigat√≥rios.', 'error'); setFormLoading(form, false); return; }
        try {
            const { error } = id ? await supabase.from('servicos').update(servicoData).eq('id', id) : await supabase.from('servicos').insert(servicoData);
            if (error) throw error;
            showToast(`Servi√ßo ${id ? 'atualizado' : 'cadastrado'}!`, 'success');
            form.reset();
            form['servico-id'].value = '';
            await loadAndRenderAll();
        } catch(error) {
            console.error('Erro ao salvar servi√ßo:', error);
            showToast(`Erro ao salvar servi√ßo: ${error.message}`, 'error');
        } finally {
            setFormLoading(form, false);
        }
    }

    function handleEditServico(id) {
        const servico = state.servicos.find(s => s.id == id);
        if (!servico) return;
        const form = DOMElements.formServico;
        form['servico-id'].value = servico.id; form['servico-descricao'].value = servico.descricao; form['servico-valor'].value = servico.valor;
        DOMElements.nav.querySelector('[data-tab="servicos"]').click();
        form['servico-descricao'].focus();
    }

    async function handleSaveOrcamento(e) {
        e.preventDefault();
        const form = DOMElements.formOrcamento; setFormLoading(form, true);
        const formasPagamento = Array.from(form.querySelectorAll('input[name="pagamento"]:checked')).map(cb => cb.value);
        const orcamentoData = { cliente_id: form['orcamento-cliente'].value, servico_id: form['orcamento-servico'].value, desconto: parseFloat(form['orcamento-desconto'].value) || 0, formas_pagamento: formasPagamento.join(', ') };
        if (!orcamentoData.cliente_id || !orcamentoData.servico_id) { showToast('Selecione um cliente e um servi√ßo.', 'error'); setFormLoading(form, false); return; }
        try {
            const { error } = await supabase.from('orcamentos').insert(orcamentoData);
            if (error) throw error;
            showToast('Or√ßamento salvo!', 'success');
            form.reset();
            Array.from(form.querySelectorAll('input[name="pagamento"]')).forEach(cb => cb.checked = false);
            form['orcamento-desconto'].value = 0;
            await loadAndRenderAll();
            DOMElements.nav.querySelector('[data-tab="orcamentos"]').click();
        } catch (error) {
            console.error('Erro ao salvar or√ßamento:', error);
            showToast(`Erro ao salvar or√ßamento: ${error.message}`, 'error');
        } finally {
            setFormLoading(form, false);
        }
    }

    function handleViewOrcamento(id) {
        const orc = state.orcamentos.find(o => o.id == id);
        if (!orc) { showToast('Or√ßamento n√£o encontrado.', 'error'); return; }
        state.orcamentoAtual = orc;
        const dt = new Date(orc.created_at); const dataFormatada = dt.toLocaleDateString('pt-BR');
        const valorOriginal = orc.servicos.valor; const descontoValor = valorOriginal * (orc.desconto / 100); const valorFinal = valorOriginal - descontoValor;
        state.textoOrcamentoAtual = `Or√ßamento R.M. Est√©tica Automotiva\n=====================================\nData: ${dataFormatada}\nCliente: ${orc.clientes.nome}\nTelefone: ${orc.clientes.telefone || '-'}\nVe√≠culo: ${orc.clientes.carro || '-'} (Placa: ${orc.clientes.placa || '-'})\n=====================================\nSERVI√áO PROPOSTO:\n- ${orc.servicos.descricao}\n=====================================\nVALORES:\n- Valor do Servi√ßo: .... R$ ${valorOriginal.toFixed(2)}\n- Desconto Aplicado: ... ${orc.desconto}% (R$ ${descontoValor.toFixed(2)})\n- VALOR TOTAL: ......... R$ ${valorFinal.toFixed(2)}\n=====================================\nFormas de Pagamento Aceitas:\n${orc.formas_pagamento || 'N√£o especificado'}\n=====================================\nV√°lido por 7 dias.\nObrigado pela prefer√™ncia!\nContato: (24) 99948-6232`;
        state.textoReciboAtual = '';
        DOMElements.historicoTexto.textContent = state.textoOrcamentoAtual;
        setHistoryButtonsState(true);
        DOMElements.nav.querySelector('[data-tab="historico"]').click();
    }

    function handleGerarRecibo() {
        if (!state.orcamentoAtual) { return showToast('Selecione um or√ßamento primeiro.', 'error'); }
        const orc = state.orcamentoAtual;
        const dt = new Date(); const dataFormatada = dt.toLocaleDateString('pt-BR');
        const valorFinal = orc.servicos.valor * (1 - (orc.desconto / 100));
        state.textoReciboAtual = `RECIBO DE SERVI√áO (CUPOM N√ÉO FISCAL)\n=====================================\nData da Finaliza√ß√£o: ${dataFormatada}\nCliente: ${orc.clientes.nome}\nVe√≠culo: ${orc.clientes.carro || '-'} (Placa: ${orc.clientes.placa || '-'})\n=====================================\nSERVI√áO REALIZADO:\n- ${orc.servicos.descricao}\n=====================================\nPAGAMENTO:\n- VALOR PAGO: .......... R$ ${valorFinal.toFixed(2)}\n- Forma de Pagamento: .. ${orc.formas_pagamento || 'N√£o especificado'}\n=====================================\nDeclaramos que o servi√ßo acima foi\nconclu√≠do e o pagamento recebido.\n\nA R.M. Est√©tica Automotiva agradece\na sua confian√ßa e prefer√™ncia!\nVolte sempre!\n=====================================\nContato: (24) 99948-6232`;
        DOMElements.historicoTexto.textContent = state.textoReciboAtual;
        showToast('Recibo de servi√ßo gerado!', 'success');
    }

    function handleDelete(id, tableName, itemName) {
        showConfirmationModal(`Tem certeza que deseja excluir este ${itemName}? A a√ß√£o n√£o pode ser desfeita.`, async () => {
            try {
                const { error } = await supabase.from(tableName).delete().eq('id', id);
                if (error) throw error;
                showToast(`${itemName} exclu√≠do com sucesso.`, 'success');
                // Se um or√ßamento for exclu√≠do, limpa a tela de hist√≥rico se for o or√ßamento atual
                if(tableName === 'orcamentos' && state.orcamentoAtual && state.orcamentoAtual.id == id) {
                    DOMElements.historicoTexto.textContent = 'Selecione um or√ßamento na aba "Or√ßamentos" para ver os detalhes aqui.';
                    setHistoryButtonsState(false);
                }
                await loadAndRenderAll();
            } catch(error) {
                console.error(`Erro ao excluir ${itemName}:`, error);
                showToast(`Erro ao excluir ${itemName}: ${error.message}`, 'error');
            }
        });
    }

    function handleGerarPdf(texto, nomeArquivo) {
        if (!texto) return showToast('Nenhum texto para gerar PDF.', 'error');
        try {
            const doc = new jsPDF();
            doc.setFont('Courier', 'normal'); doc.setFontSize(10); doc.text(texto, 10, 10);
            doc.save(nomeArquivo);
            showToast('PDF gerado com sucesso!', 'success');
        } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            showToast("N√£o foi poss√≠vel gerar o PDF.", "error");
        }
    }

    function handleEnviarWhatsApp(texto) {
        if (!texto) return showToast('Nenhum texto para enviar.', 'error');
        const textoURI = encodeURIComponent(texto);
        window.open(`https://wa.me/?text=${textoURI}`, '_blank');
    }

    // --- SETUP DOS EVENT LISTENERS ---
    function setupEventListeners() {
        DOMElements.nav.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const tabId = e.target.dataset.tab;
            DOMElements.tabs.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            DOMElements.tabContents.forEach(tc => tc.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
        });

        DOMElements.formCliente.addEventListener('submit', handleSaveCliente);
        DOMElements.formServico.addEventListener('submit', handleSaveServico);
        DOMElements.formOrcamento.addEventListener('submit', handleSaveOrcamento);

        DOMElements.searchClientes.addEventListener('input', e => renderClientes(e.target.value));
        DOMElements.searchServicos.addEventListener('input', e => renderServicos(e.target.value));
        
        const createListHandler = (editHandler, deleteHandler, viewHandler) => (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const id = button.closest('li').dataset.id;
            const action = button.dataset.action;
            if (action === 'edit' && editHandler) editHandler(id);
            if (action === 'delete' && deleteHandler) deleteHandler(id);
            if (action === 'view' && viewHandler) viewHandler(id);
        };

        DOMElements.listaClientes.addEventListener('click', createListHandler(handleEditCliente, (id) => handleDelete(id, 'clientes', 'cliente')));
        DOMElements.listaServicos.addEventListener('click', createListHandler(handleEditServico, (id) => handleDelete(id, 'servi√ßos', 'servi√ßo')));
        DOMElements.listaOrcamentos.addEventListener('click', createListHandler(null, (id) => handleDelete(id, 'orcamentos', 'or√ßamento'), handleViewOrcamento));
        
        DOMElements.btnGerarOrcamentoPDF.addEventListener('click', () => handleGerarPdf(state.textoOrcamentoAtual, 'orcamento_rm_estetica.pdf'));
        DOMElements.btnEnviarOrcamentoWhats.addEventListener('click', () => handleEnviarWhatsApp(state.textoOrcamentoAtual));
        DOMElements.btnGerarReciboPDF.addEventListener('click', () => { if (!state.textoReciboAtual) handleGerarRecibo(); if (state.textoReciboAtual) handleGerarPdf(state.textoReciboAtual, 'recibo_rm_estetica.pdf'); });
        DOMElements.btnEnviarReciboWhats.addEventListener('click', () => { if (!state.textoReciboAtual) handleGerarRecibo(); if (state.textoReciboAtual) handleEnviarWhatsApp(state.textoReciboAtual); });
    }

    // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
    async function init() {
        console.log("Iniciando aplica√ß√£o...");
        setupEventListeners();
        await loadAndRenderAll();
        console.log("Aplica√ß√£o pronta.");
    }

    init();
</script>
</body>
</html>
