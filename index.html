<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R.M. Est√©tica Automotiva</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; margin: 0; }
    header { background: #800; padding: 10px; text-align: center; font-size: 1.4em; color: #FFD700; }
    nav { display: flex; background: #222; }
    nav button { flex: 1; padding: 10px; background: #333; border: none; color: #eee; font-weight: bold; cursor: pointer; }
    nav button.active { background: #800; color: #fff; }
    section { display: none; padding: 15px; }
    section.active { display: block; }
    form input, form select, form button, textarea {
      display: block; width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 5px;
      border: none; font-size: 1em;
    }
    ul { list-style: none; padding: 0; }
    li { background: #222; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; flex-wrap: wrap; }
    .actions button { margin-left: 5px; }
  </style>
</head>
<body>
  <header>R.M. Est√©tica Automotiva</header>
  <nav>
    <button data-tab="clientes" class="active">Clientes</button>
    <button data-tab="servicos">Servi√ßos</button>
    <button data-tab="orcamento">Or√ßamento</button>
    <button data-tab="historico">Hist√≥rico</button>
  </nav>

  <section id="clientes" class="active">
    <h2>Cadastro de Clientes</h2>
    <form id="form-clientes">
      <input type="text" id="nome" placeholder="Nome" required>
      <input type="text" id="telefone" placeholder="Telefone">
      <input type="text" id="carro" placeholder="Carro">
      <input type="text" id="placa" placeholder="Placa">
      <button type="submit">Salvar Cliente</button>
    </form>
    <ul id="lista-clientes"></ul>
  </section>

  <section id="servicos">
    <h2>Cadastro de Servi√ßos</h2>
    <form id="form-servicos">
      <input type="text" id="descricao" placeholder="Descri√ß√£o" required>
      <input type="number" id="valor" placeholder="Valor" required>
      <button type="submit">Salvar Servi√ßo</button>
    </form>
    <ul id="lista-servicos"></ul>
  </section>

  <section id="orcamento">
    <h2>Gerar Or√ßamento</h2>
    <form id="form-orcamento">
      <select id="select-cliente" required></select>
      <select id="select-servico" required></select>
      <input type="number" id="desconto" placeholder="Desconto %">
      <button type="submit">Salvar Or√ßamento</button>
    </form>
  </section>

  <section id="historico">
    <h2>Hist√≥rico de Or√ßamentos</h2>
    <ul id="lista-orcamentos"></ul>
    <pre id="historico-texto"></pre>
    <button id="btn-salvar-orcamento">Salvar Or√ßamento</button>
    <button id="btn-enviar-orcamento">Enviar Or√ßamento</button>
    <button id="btn-salvar-cupom">Salvar Cupom</button>
    <button id="btn-enviar-cupom">Enviar Cupom</button>
  </section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabase = supabase.createClient(
  'https://zkdfimbfwgofkmmcvyfu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE'
);

const tabs = document.querySelectorAll('nav button');
tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelector('nav button.active').classList.remove('active');
    btn.classList.add('active');
    document.querySelector('section.active').classList.remove('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

async function carregarClientes() {
  const { data } = await supabase.from('clientes').select('*');
  const lista = document.getElementById('lista-clientes');
  const select = document.getElementById('select-cliente');
  lista.innerHTML = select.innerHTML = '';
  data.forEach(c => {
    lista.innerHTML += `<li>${c.nome} - ${c.carro} (${c.placa})</li>`;
    select.innerHTML += `<option value="${c.id}">${c.nome} - ${c.carro}</option>`;
  });
}

async function carregarServicos() {
  const { data } = await supabase.from('servicos').select('*');
  const lista = document.getElementById('lista-servicos');
  const select = document.getElementById('select-servico');
  lista.innerHTML = select.innerHTML = '';
  data.forEach(s => {
    lista.innerHTML += `<li>${s.descricao} - R$ ${s.valor.toFixed(2)}</li>`;
    select.innerHTML += `<option value="${s.id}">${s.descricao}</option>`;
  });
}

async function carregarOrcamentos() {
  const { data, error } = await supabase.from('orcamentos').select(`
    id, desconto, created_at,
    clientes (nome, telefone, carro, placa),
    servicos (descricao, valor)
  `).order('created_at', { ascending: false });

  const lista = document.getElementById('lista-orcamentos');
  lista.innerHTML = '';

  if (error) {
    lista.innerHTML = '<li>Erro ao carregar or√ßamentos</li>';
    return;
  }

  data.forEach(o => {
    const total = o.servicos.valor * (1 - o.desconto / 100);
    const texto = `üßæ Or√ßamento R.M. Est√©tica Automotiva\n\nCliente: ${o.clientes.nome}\nCarro: ${o.clientes.carro} (${o.clientes.placa})\nServi√ßo: ${o.servicos.descricao} - R$ ${o.servicos.valor.toFixed(2)}\nDesconto: ${o.desconto}%\nTotal: R$ ${total.toFixed(2)}\n\nObrigado pela prefer√™ncia!`;

    lista.innerHTML += `
    <li>
      <div>
        <strong>${o.clientes.nome}</strong><br>
        ${o.servicos.descricao} - R$ ${total.toFixed(2)}
      </div>
      <div class="actions">
        <button onclick="document.getElementById('historico-texto').textContent = \`${texto}\`">Ver</button>
      </div>
    </li>`;
  });
}

document.getElementById('form-clientes').addEventListener('submit', async e => {
  e.preventDefault();
  const nome = document.getElementById('nome').value;
  const telefone = document.getElementById('telefone').value;
  const carro = document.getElementById('carro').value;
  const placa = document.getElementById('placa').value;
  await supabase.from('clientes').insert([{ nome, telefone, carro, placa }]);
  carregarClientes();
  e.target.reset();
});

document.getElementById('form-servicos').addEventListener('submit', async e => {
  e.preventDefault();
  const descricao = document.getElementById('descricao').value;
  const valor = parseFloat(document.getElementById('valor').value);
  await supabase.from('servicos').insert([{ descricao, valor }]);
  carregarServicos();
  e.target.reset();
});

document.getElementById('form-orcamento').addEventListener('submit', async e => {
  e.preventDefault();
  const cliente_id = parseInt(document.getElementById('select-cliente').value);
  const servico_id = parseInt(document.getElementById('select-servico').value);
  const desconto = parseFloat(document.getElementById('desconto').value) || 0;
  await supabase.from('orcamentos').insert([{ cliente_id, servico_id, desconto }]);
  carregarOrcamentos();
  e.target.reset();
});

carregarClientes();
carregarServicos();
carregarOrcamentos();
</script>
</body>
</html>
