<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.M. Est√©tica Automotiva</title>
  <style>
    /* Reset e base */
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #ddd;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }
    header {
      background: #b34747; /* vermelho suave */
      padding: 15px 20px;
      font-weight: bold;
      font-size: 1.5rem;
      color: #fff9d0; /* amarelo suave */
      text-align: center;
      user-select: none;
    }
    nav {
      display: flex;
      background: #451b1b;
    }
    nav button {
      flex: 1;
      padding: 12px;
      background: #451b1b;
      border: none;
      color: #ddd;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 1rem;
    }
    nav button:hover {
      background: #6d2b2b;
    }
    nav button.active {
      background: #f7e072; /* amarelo suave */
      color: #3a120b;
      font-weight: 700;
    }
    main {
      flex-grow: 1;
      padding: 15px 20px;
      overflow-y: auto;
    }
    section {
      display: none;
      animation: fadeIn 0.3s ease forwards;
    }
    section.active {
      display: block;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity:1;}
    }
    form {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      max-width: 500px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(255, 230, 120, 0.3);
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    input[type=text], input[type=number], select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: none;
      background: #444;
      color: #ddd;
      font-size: 1rem;
      transition: background-color 0.2s ease;
    }
    input[type=text]:focus, input[type=number]:focus, select:focus {
      outline: none;
      background: #5a5a5a;
    }
    button {
      background: #b34747;
      border: none;
      padding: 10px 18px;
      font-weight: bold;
      color: #fff9d0;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 1rem;
      user-select: none;
    }
    button:hover {
      background: #a03c3c;
    }
    .listagem {
      max-width: 600px;
      margin-top: 10px;
      border-radius: 8px;
      background: #2a2a2a;
      padding: 10px;
      box-shadow: 0 0 8px rgba(255, 230, 120, 0.2);
      color: #ddd;
    }
    .listagem table {
      width: 100%;
      border-collapse: collapse;
    }
    .listagem th, .listagem td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #444;
      font-size: 0.95rem;
    }
    .listagem th {
      background: #3a3a3a;
    }
    .acoes button {
      margin-right: 6px;
      padding: 5px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
    }
    .acoes button.editar {
      background: #f7e072;
      color: #3a120b;
    }
    .acoes button.excluir {
      background: #cc5555;
      color: #fff;
    }
  </style>
</head>
<body>

<header>R.M. Est√©tica Automotiva</header>

<nav>
  <button data-tab="clientes" class="active">Clientes</button>
  <button data-tab="servicos">Servi√ßos</button>
  <button data-tab="orcamentos">Or√ßamentos</button>
  <button data-tab="historico">Hist√≥rico</button>
</nav>

<main>
  <section id="clientes" class="active">
    <h2>Clientes</h2>
    <form id="form-cliente">
      <label for="nome">Nome:</label>
      <input type="text" id="nome" name="nome" required />
      
      <label for="telefone">Telefone:</label>
      <input type="text" id="telefone" name="telefone" required />
      
      <label for="carro">Carro:</label>
      <input type="text" id="carro" name="carro" />
      
      <label for="placa">Placa:</label>
      <input type="text" id="placa" name="placa" />
      
      <button type="submit">Cadastrar Cliente</button>
    </form>
    <div class="listagem" id="lista-clientes"></div>
  </section>

  <section id="servicos">
    <h2>Servi√ßos</h2>
    <form id="form-servico">
      <label for="descricao">Descri√ß√£o:</label>
      <input type="text" id="descricao" name="descricao" required />
      
      <label for="valor">Valor (R$):</label>
      <input type="number" id="valor" name="valor" min="0" step="0.01" required />
      
      <button type="submit">Cadastrar Servi√ßo</button>
    </form>
    <div class="listagem" id="lista-servicos"></div>
  </section>

  <section id="orcamentos">
    <h2>Or√ßamentos</h2>
    <form id="form-orcamento">
      <label for="select-cliente">Cliente:</label>
      <select id="select-cliente" required>
        <option value="">Selecione um cliente</option>
      </select>

      <label for="select-servico">Servi√ßo:</label>
      <select id="select-servico" required>
        <option value="">Selecione um servi√ßo</option>
      </select>

      <label for="desconto">Desconto (%):</label>
      <input type="number" id="desconto" name="desconto" min="0" max="100" step="0.01" value="0" />

      <button type="submit">Gerar Or√ßamento</button>
    </form>

    <div class="listagem" id="lista-orcamentos"></div>
  </section>

  <section id="historico">
    <h2>Hist√≥rico</h2>
    <div class="listagem" id="lista-historico"></div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://zkdfimbfwgofkmmcvyfu.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Navega√ß√£o entre abas
  const tabs = document.querySelectorAll('nav button');
  const sections = document.querySelectorAll('section');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      sections.forEach(s => s.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.dataset.tab;
      document.getElementById(target).classList.add('active');
    });
  });

  // Fun√ß√µes para carregar listas
  async function carregarClientes() {
    let { data, error } = await supabase.from('clientes').select('*').order('id', { ascending: false });
    if (error) return alert('Erro ao carregar clientes: ' + error.message);

    const lista = document.getElementById('lista-clientes');
    lista.innerHTML = '';

    if (!data.length) {
      lista.innerHTML = '<p>Nenhum cliente cadastrado.</p>';
      preencherSelectClientes([]);
      return;
    }

    // Montar tabela slim
    let html = '<table><thead><tr><th>Nome</th><th>Telefone</th><th>Carro</th><th>Placa</th><th>A√ß√µes</th></tr></thead><tbody>';
    data.forEach(c => {
      html += `<tr>
        <td>${c.nome}</td>
        <td>${c.telefone}</td>
        <td>${c.carro || ''}</td>
        <td>${c.placa || ''}</td>
        <td class="acoes">
          <button class="editar" onclick="editarCliente(${c.id})">‚úèÔ∏è</button>
          <button class="excluir" onclick="excluirCliente(${c.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    lista.innerHTML = html;

    preencherSelectClientes(data);
  }

  async function carregarServicos() {
    let { data, error } = await supabase.from('servicos').select('*').order('id', { ascending: false });
    if (error) return alert('Erro ao carregar servi√ßos: ' + error.message);

    const lista = document.getElementById('lista-servicos');
    lista.innerHTML = '';

    if (!data.length) {
      lista.innerHTML = '<p>Nenhum servi√ßo cadastrado.</p>';
      preencherSelectServicos([]);
      return;
    }

    let html = '<table><thead><tr><th>Descri√ß√£o</th><th>Valor (R$)</th><th>A√ß√µes</th></tr></thead><tbody>';
    data.forEach(s => {
      html += `<tr>
        <td>${s.descricao}</td>
        <td>${Number(s.valor).toFixed(2)}</td>
        <td class="acoes">
          <button class="editar" onclick="editarServico(${s.id})">‚úèÔ∏è</button>
          <button class="excluir" onclick="excluirServico(${s.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    lista.innerHTML = html;

    preencherSelectServicos(data);
  }

  async function carregarOrcamentos() {
    // Puxa dados com join para mostrar nome e servi√ßo
    let { data, error } = await supabase
      .from('orcamentos')
      .select(`
        id,
        desconto,
        created_at,
        clientes(nome, telefone, carro, placa),
        servicos(descricao, valor)
      `)
      .order('created_at', { ascending: false });

    if (error) return alert('Erro ao carregar or√ßamentos: ' + error.message);

    const lista = document.getElementById('lista-orcamentos');
    lista.innerHTML = '';

    if (!data.length) {
      lista.innerHTML = '<p>Nenhum or√ßamento gerado.</p>';
      return;
    }

    let html = '<table><thead><tr><th>Cliente</th><th>Servi√ßo</th><th>Desconto (%)</th><th>Total (R$)</th><th>Data</th><th>A√ß√µes</th></tr></thead><tbody>';
    data.forEach(o => {
      const valorOriginal = o.servicos?.valor || 0;
      const desconto = o.desconto || 0;
      const total = valorOriginal * (1 - desconto / 100);
      const dataFormat = new Date(o.created_at).toLocaleString('pt-BR');

      html += `<tr>
        <td>${o.clientes?.nome || ''}</td>
        <td>${o.servicos?.descricao || ''}</td>
        <td>${desconto.toFixed(2)}</td>
        <td>${total.toFixed(2)}</td>
        <td>${dataFormat}</td>
        <td class="acoes">
          <button class="editar" onclick="editarOrcamento(${o.id})">‚úèÔ∏è</button>
          <button class="excluir" onclick="excluirOrcamento(${o.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    lista.innerHTML = html;
  }

  // HIST√ìRICO: mostra os or√ßamentos em formato cupom e or√ßamento e op√ß√µes para salvar/enviar
  async function carregarHistorico() {
    let { data, error } = await supabase
      .from('orcamentos')
      .select(`
        id,
        desconto,
        created_at,
        clientes(nome, telefone, carro, placa),
        servicos(descricao, valor)
      `)
      .order('created_at', { ascending: false });
    if (error) return alert('Erro ao carregar hist√≥rico: ' + error.message);

    const lista = document.getElementById('lista-historico');
    lista.innerHTML = '';

    if (!data.length) {
      lista.innerHTML = '<p>Sem hist√≥rico para mostrar.</p>';
      return;
    }

    let html = '';
    data.forEach(o => {
      const valorOriginal = o.servicos?.valor || 0;
      const desconto = o.desconto || 0;
      const total = valorOriginal * (1 - desconto / 100);
      const dataFormat = new Date(o.created_at).toLocaleString('pt-BR');

      const textoOrcamento =
`ÔøΩ Or√ßamento R.M. Est√©tica Automotiva ÔøΩ

==============================
       R.M. EST√âTICA AUTOMOTIVA
==============================
Data: ${dataFormat}
Cliente: ${o.clientes?.nome || ''}
Carro: ${o.clientes?.carro || ''} (${o.clientes?.placa || ''})
------------------------------
SERVI√áOS:
- ${o.servicos?.descricao || ''}  R$ ${valorOriginal.toFixed(2)}
------------------------------
Desconto: ${desconto.toFixed(2)}%
Total: R$ ${total.toFixed(2)}
------------------------------
LOJA PARA CONTATO:
Tel: ${o.clientes?.telefone || ''}
Endere√ßo:
Rua 40, Travessa Recanto dos P√°ssaros
==============================
    Obrigado pela prefer√™ncia!
==============================

ÔøΩ Entre em contato conosco para agendar seu servi√ßo!
Obrigado pela prefer√™ncia! ÔøΩ
`;

      html += `<div style="margin-bottom: 20px; background:#2a2a2a; padding: 15px; border-radius: 8px; box-shadow: 0 0 12px #f7e072;">
        <pre style="white-space: pre-wrap; font-family: monospace;">${textoOrcamento}</pre>
        <button onclick="baixarPDF('${textoOrcamento}', ${o.id}, 'orcamento')">Salvar PDF</button>
        <button onclick="enviarWhatsApp('${textoOrcamento}')">Enviar WhatsApp</button>
      </div>`;
    });
    lista.innerHTML = html;
  }

  // Fun√ß√£o para baixar texto como PDF simples
  function baixarPDF(texto, id, tipo) {
    const doc = new jsPDF();
    doc.setFontSize(12);
    const splitText = doc.splitTextToSize(texto, 180);
    doc.text(splitText, 10, 10);
    doc.save(`${tipo}_${id}.pdf`);
  }

  // Fun√ß√£o para enviar WhatsApp
  function enviarWhatsApp(texto) {
    const numero = prompt('Digite o n√∫mero do WhatsApp com DDD (ex: 5599999999999):');
    if (!numero) return;
    const textoUrl = encodeURIComponent(texto);
    window.open(`https://wa.me/${numero}?text=${textoUrl}`, '_blank');
  }

  // Formul√°rios: inserir dados
  document.getElementById('form-cliente').addEventListener('submit', async e => {
    e.preventDefault();
    const nome = e.target.nome.value.trim();
    const telefone = e.target.telefone.value.trim();
    const carro = e.target.carro.value.trim();
    const placa = e.target.placa.value.trim();
    if (!nome || !telefone) return alert('Nome e telefone s√£o obrigat√≥rios.');

    const { error } = await supabase.from('clientes').insert([{ nome, telefone, carro, placa }]);
    if (error) return alert('Erro ao salvar cliente: ' + error.message);

    e.target.reset();
    carregarClientes();
    alert('Cliente salvo com sucesso!');
  });

  document.getElementById('form-servico').addEventListener('submit', async e => {
    e.preventDefault();
    const descricao = e.target.descricao.value.trim();
    const valor = parseFloat(e.target.valor.value);
    if (!descricao || isNaN(valor) || valor <= 0) return alert('Descri√ß√£o e valor v√°lidos s√£o obrigat√≥rios.');

    const { error } = await supabase.from('servicos').insert([{ descricao, valor }]);
    if (error) return alert('Erro ao salvar servi√ßo: ' + error.message);

    e.target.reset();
    carregarServicos();
    alert('Servi√ßo salvo com sucesso!');
  });

  document.getElementById('form-orcamento').addEventListener('submit', async e => {
    e.preventDefault();
    const clienteId = document.getElementById('select-cliente').value;
    const servicoId = document.getElementById('select-servico').value;
    const desconto = parseFloat(document.getElementById('desconto').value) || 0;
    if (!clienteId || !servicoId) return alert('Selecione cliente e servi√ßo.');

    const { error } = await supabase.from('orcamentos').insert([{ cliente_id: clienteId, servico_id: servicoId, desconto }]);
    if (error) return alert('Erro ao salvar or√ßamento: ' + error.message);

    e.target.reset();
    carregarOrcamentos();
    carregarHistorico();
    alert('Or√ßamento salvo com sucesso!');
  });

  // Fun√ß√µes para preencher selects
  function preencherSelectClientes(clientes) {
    const select = document.getElementById('select-cliente');
    select.innerHTML = '<option value="">Selecione um cliente</option>';
    clientes.forEach(c => {
      select.innerHTML += `<option value="${c.id}">${c.nome} (${c.carro || 'sem carro'})</option>`;
    });
  }
  function preencherSelectServicos(servicos) {
    const select = document.getElementById('select-servico');
    select.innerHTML = '<option value="">Selecione um servi√ßo</option>';
    servicos.forEach(s => {
      select.innerHTML += `<option value="${s.id}">${s.descricao} - R$ ${Number(s.valor).toFixed(2)}</option>`;
    });
  }

  // Excluir e editar clientes
  window.excluirCliente = async function(id) {
    if(!confirm('Excluir cliente?')) return;
    const { error } = await supabase.from('clientes').delete().eq('id', id);
    if (error) return alert('Erro ao excluir cliente: ' + error.message);
    carregarClientes();
  };

  window.editarCliente = function(id) {
    alert('Editar cliente ainda n√£o implementado.');
  };

  // Excluir e editar servi√ßos
  window.excluirServico = async function(id) {
    if(!confirm('Excluir servi√ßo?')) return;
    const { error } = await supabase.from('servicos').delete().eq('id', id);
    if (error) return alert('Erro ao excluir servi√ßo: ' + error.message);
    carregarServicos();
  };

  window.editarServico = function(id) {
    alert('Editar servi√ßo ainda n√£o implementado.');
  };

  // Excluir e editar or√ßamentos
  window.excluirOrcamento = async function(id) {
    if(!confirm('Excluir or√ßamento?')) return;
    const { error } = await supabase.from('orcamentos').delete().eq('id', id);
    if (error) return alert('Erro ao excluir or√ßamento: ' + error.message);
    carregarOrcamentos();
    carregarHistorico();
  };

  window.editarOrcamento = function(id) {
    alert('Editar or√ßamento ainda n√£o implementado.');
  };

  // Inicializa√ß√£o
  carregarClientes();
  carregarServicos();
  carregarOrcamentos();
  carregarHistorico();

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const { jsPDF } = window.jspdf;
</script>

</body>
</html>
