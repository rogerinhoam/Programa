<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.M. Est√©tica Automotiva</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <style>
    /* Cores tema escuro com vermelho suave e amarelo suave */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #f2e7bc; /* amarelo suave */
    }
    header {
      background-color: #3b1f1f; /* vermelho suave */
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 10px 0;
      font-weight: bold;
    }
    header button {
      background: none;
      border: none;
      color: #f2e7bc;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    header button:hover,
    header button.active {
      background-color: #f2e7bc;
      color: #3b1f1f;
    }
    main {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    section {
      display: none;
    }
    section.active {
      display: block;
    }
    form {
      background-color: #1f1f1f;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #622222;
      background-color: #121212;
      color: #f2e7bc;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 5px;
    }
    button.submit-btn {
      margin-top: 15px;
      background-color: #622222;
      color: #f2e7bc;
      border: none;
      padding: 12px;
      width: 100%;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button.submit-btn:hover {
      background-color: #7e2a2a;
    }
    .list-item {
      background-color: #1f1f1f;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #f2e7bc;
    }
    .list-item button {
      background: none;
      border: none;
      color: #f2e7bc;
      cursor: pointer;
      margin-left: 10px;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }
    .list-item button:hover {
      color: #ffb74d;
    }
    #cupom {
      background-color: #1f1f1f;
      border: 1px solid #622222;
      padding: 15px;
      white-space: pre-wrap;
      font-family: monospace;
      margin-bottom: 20px;
      border-radius: 8px;
      color: #f2e7bc;
    }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .btn-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .btn-pdf {
      background-color: #f2e7bc;
      color: #3b1f1f;
    }
    .btn-pdf:hover {
      background-color: #e6d98f;
    }
    .btn-whats {
      background-color: #622222;
      color: #f2e7bc;
    }
    .btn-whats:hover {
      background-color: #7e2a2a;
    }
  </style>
</head>
<body>

<header>
  <button id="btnClientes" class="active">Clientes</button>
  <button id="btnServicos">Servi√ßos</button>
  <button id="btnOrcamentos">Or√ßamentos</button>
  <button id="btnHistorico">Hist√≥rico</button>
</header>

<main>
  <!-- Clientes -->
  <section id="clientes" class="active">
    <form id="formCliente">
      <input type="hidden" id="clienteId" />
      <label for="nomeCliente">Nome</label>
      <input type="text" id="nomeCliente" placeholder="Nome do cliente" required />
      <label for="telefoneCliente">Telefone</label>
      <input type="text" id="telefoneCliente" placeholder="(00) 00000-0000" required />
      <button type="submit" class="submit-btn">Salvar Cliente</button>
    </form>
    <div id="listaClientes"></div>
  </section>

  <!-- Servi√ßos -->
  <section id="servicos">
    <form id="formServico">
      <input type="hidden" id="servicoId" />
      <label for="descricaoServico">Descri√ß√£o</label>
      <input type="text" id="descricaoServico" placeholder="Descri√ß√£o do servi√ßo" required />
      <label for="valorServico">Valor (R$)</label>
      <input type="number" step="0.01" id="valorServico" placeholder="0.00" required />
      <button type="submit" class="submit-btn">Salvar Servi√ßo</button>
    </form>
    <div id="listaServicos"></div>
  </section>

  <!-- Or√ßamentos -->
  <section id="orcamentos">
    <form id="formOrcamento">
      <input type="hidden" id="orcamentoId" />
      <label for="clienteSelect">Cliente</label>
      <select id="clienteSelect" required></select>

      <label for="servicoSelect">Servi√ßo</label>
      <select id="servicoSelect" required></select>

      <label for="carroOrcamento">Carro</label>
      <input type="text" id="carroOrcamento" placeholder="Ex: uno (lpj5361)" required />

      <label for="descontoOrcamento">Desconto (%)</label>
      <input type="number" step="0.01" min="0" max="100" id="descontoOrcamento" value="0" />

      <fieldset style="margin-top:10px; border:1px solid #622222; padding:10px; border-radius:6px; color:#f2e7bc;">
        <legend>Forma(s) de Pagamento</legend>
        <label><input type="checkbox" name="pagamento" value="Dinheiro" /> Dinheiro</label>
        <label><input type="checkbox" name="pagamento" value="Pix" /> Pix</label>
        <label><input type="checkbox" name="pagamento" value="Cart√£o" /> Cart√£o</label>
      </fieldset>

      <button type="submit" class="submit-btn">Salvar Or√ßamento</button>
    </form>

    <pre id="cupom"></pre>

    <div class="btn-group">
      <button id="btnPdf" class="btn-pdf">üíæ Salvar PDF</button>
      <button id="btnWhats" class="btn-whats">üì≤ Enviar WhatsApp</button>
    </div>
  </section>

  <!-- Hist√≥rico -->
  <section id="historico">
    <div id="listaHistorico"></div>
  </section>
</main>

<script>
  // Inicializar Supabase
  const supabaseUrl = 'https://zkdfimbfwgofkmmcvyfu.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprZGZpbWJmd2dvZmttbWN2eWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzQxMTksImV4cCI6MjA2NjIxMDExOX0.vOTrEVYX30FpWPQykY5CF1QCfkyG5gDLnI_2N9TATRE';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Elementos
  const sections = {
    clientes: document.getElementById('clientes'),
    servicos: document.getElementById('servicos'),
    orcamentos: document.getElementById('orcamentos'),
    historico: document.getElementById('historico'),
  };

  const buttons = {
    clientes: document.getElementById('btnClientes'),
    servicos: document.getElementById('btnServicos'),
    orcamentos: document.getElementById('btnOrcamentos'),
    historico: document.getElementById('btnHistorico'),
  };

  function mostrarAba(nome) {
    for (const key in sections) {
      if (key === nome) {
        sections[key].classList.add('active');
        buttons[key].classList.add('active');
      } else {
        sections[key].classList.remove('active');
        buttons[key].classList.remove('active');
      }
    }
  }

  // Inicializa abas
  buttons.clientes.onclick = () => mostrarAba('clientes');
  buttons.servicos.onclick = () => mostrarAba('servicos');
  buttons.orcamentos.onclick = () => mostrarAba('orcamentos');
  buttons.historico.onclick = () => {
    mostrarAba('historico');
    carregarHistorico();
  };

  // --- Clientes ---
  const formCliente = document.getElementById('formCliente');
  const listaClientes = document.getElementById('listaClientes');
  const inputNomeCliente = document.getElementById('nomeCliente');
  const inputTelefoneCliente = document.getElementById('telefoneCliente');
  const inputClienteId = document.getElementById('clienteId');

  async function carregarClientes() {
    const { data, error } = await supabase.from('clientes').select('*').order('id', { ascending: false });
    if (error) {
      alert('Erro ao carregar clientes: ' + error.message);
      return;
    }
    listaClientes.innerHTML = '';
    const clienteSelect = document.getElementById('clienteSelect');
    clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';

    data.forEach(cliente => {
      // Lista para edi√ß√£o/exclus√£o
      const div = document.createElement('div');
      div.className = 'list-item';
      div.textContent = `${cliente.nome} - ${cliente.telefone}`;

      const btnEditar = document.createElement('button');
      btnEditar.textContent = '‚úèÔ∏è';
      btnEditar.title = 'Editar';
      btnEditar.onclick = () => {
        inputClienteId.value = cliente.id;
        inputNomeCliente.value = cliente.nome;
        inputTelefoneCliente.value = cliente.telefone;
        mostrarAba('clientes');
      };

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'üóëÔ∏è';
      btnExcluir.title = 'Excluir';
      btnExcluir.onclick = async () => {
        if (confirm(`Excluir cliente ${cliente.nome}?`)) {
          const { error } = await supabase.from('clientes').delete().eq('id', cliente.id);
          if (error) alert('Erro ao excluir: ' + error.message);
          else carregarClientes();
        }
      };

      div.appendChild(btnEditar);
      div.appendChild(btnExcluir);
      listaClientes.appendChild(div);

      // Popula select cliente do or√ßamento
      const option = document.createElement('option');
      option.value = cliente.id;
      option.textContent = cliente.nome;
      clienteSelect.appendChild(option);
    });
  }

  formCliente.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nome = inputNomeCliente.value.trim();
    const telefone = inputTelefoneCliente.value.trim();
    const id = inputClienteId.value;

    if (!nome || !telefone) {
      alert('Preencha todos os campos!');
      return;
    }

    if (id) {
      const { error } = await supabase.from('clientes').update({ nome, telefone }).eq('id', id);
      if (error) alert('Erro ao atualizar: ' + error.message);
      else {
        alert('Cliente atualizado!');
        inputClienteId.value = '';
        formCliente.reset();
        carregarClientes();
      }
    } else {
      const { error } = await supabase.from('clientes').insert({ nome, telefone });
      if (error) alert('Erro ao cadastrar: ' + error.message);
      else {
        alert('Cliente cadastrado!');
        formCliente.reset();
        carregarClientes();
      }
    }
  });

  // --- Servi√ßos ---
  const formServico = document.getElementById('formServico');
  const listaServicos = document.getElementById('listaServicos');
  const inputDescricaoServico = document.getElementById('descricaoServico');
  const inputValorServico = document.getElementById('valorServico');
  const inputServicoId = document.getElementById('servicoId');

  async function carregarServicos() {
    const { data, error } = await supabase.from('servicos').select('*').order('id', { ascending: false });
    if (error) {
      alert('Erro ao carregar servi√ßos: ' + error.message);
      return;
    }
    listaServicos.innerHTML = '';
    const servicoSelect = document.getElementById('servicoSelect');
    servicoSelect.innerHTML = '<option value="">Selecione um servi√ßo</option>';

    data.forEach(servico => {
      // Lista para edi√ß√£o/exclus√£o
      const div = document.createElement('div');
      div.className = 'list-item';
      div.textContent = `${servico.descricao} - R$ ${servico.valor.toFixed(2)}`;

      const btnEditar = document.createElement('button');
      btnEditar.textContent = '‚úèÔ∏è';
      btnEditar.title = 'Editar';
      btnEditar.onclick = () => {
        inputServicoId.value = servico.id;
        inputDescricaoServico.value = servico.descricao;
        inputValorServico.value = servico.valor;
        mostrarAba('servicos');
      };

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'üóëÔ∏è';
      btnExcluir.title = 'Excluir';
      btnExcluir.onclick = async () => {
        if (confirm(`Excluir servi√ßo ${servico.descricao}?`)) {
          const { error } = await supabase.from('servicos').delete().eq('id', servico.id);
          if (error) alert('Erro ao excluir: ' + error.message);
          else carregarServicos();
        }
      };

      div.appendChild(btnEditar);
      div.appendChild(btnExcluir);
      listaServicos.appendChild(div);

      // Popula select servi√ßo do or√ßamento
      const option = document.createElement('option');
      option.value = servico.id;
      option.textContent = servico.descricao;
      servicoSelect.appendChild(option);
    });
  }

  formServico.addEventListener('submit', async (e) => {
    e.preventDefault();
    const descricao = inputDescricaoServico.value.trim();
    const valor = parseFloat(inputValorServico.value);
    const id = inputServicoId.value;

    if (!descricao || isNaN(valor)) {
      alert('Preencha todos os campos corretamente!');
      return;
    }

    if (id) {
      const { error } = await supabase.from('servicos').update({ descricao, valor }).eq('id', id);
      if (error) alert('Erro ao atualizar: ' + error.message);
      else {
        alert('Servi√ßo atualizado!');
        inputServicoId.value = '';
        formServico.reset();
        carregarServicos();
      }
    } else {
      const { error } = await supabase.from('servicos').insert({ descricao, valor });
      if (error) alert('Erro ao cadastrar: ' + error.message);
      else {
        alert('Servi√ßo cadastrado!');
        formServico.reset();
        carregarServicos();
      }
    }
  });

  // --- Or√ßamentos ---
  const formOrcamento = document.getElementById('formOrcamento');
  const inputClienteSelect = document.getElementById('clienteSelect');
  const inputServicoSelect = document.getElementById('servicoSelect');
  const inputCarro = document.getElementById('carroOrcamento');
  const inputDesconto = document.getElementById('descontoOrcamento');
  const cupomEl = document.getElementById('cupom');

  // Fun√ß√£o para formatar data
  function formatarData(data) {
    return data.toLocaleDateString('pt-BR') + ', ' + data.toLocaleTimeString('pt-BR');
  }

  // Gerar cupom formatado conforme solicitado
  function gerarCupom(orcamento, cliente, servico) {
    const data = new Date(orcamento.created_at || new Date());
    const desconto = orcamento.desconto || 0;
    const valorComDesconto = servico.valor * (1 - desconto / 100);
    const formasPagto = orcamento.forma_pagamento.split(',').join(', ');

    return `
ÔøΩ Or√ßamento R.M. Est√©tica Automotiva ÔøΩ

==============================
       R.M. EST√âTICA AUTOMOTIVA
==============================
Data: ${formatarData(data)}       
Cliente: ${cliente.nome}
Carro: ${orcamento.carro || '-'}
------------------------------
SERVI√áOS:
- ${servico.descricao}  R$ ${servico.valor.toFixed(2)}
------------------------------
Desconto: ${desconto.toFixed(2)}%
Total: R$ ${valorComDesconto.toFixed(2)}
Forma(s) de Pagamento: ${formasPagto}
------------------------------
LOJA PARA CONTATO:
Tel: 24 999486232
Endere√ßo:
Rua 40, Travessa Recanto dos P√°ssaros
==============================
    Obrigado pela prefer√™ncia!
==============================


ÔøΩ Entre em contato conosco para agendar seu servi√ßo!
Obrigado pela prefer√™ncia! ÔøΩ
    `.trim();
  }

  formOrcamento.addEventListener('submit', async (e) => {
    e.preventDefault();

    const cliente_id = inputClienteSelect.value;
    const servico_id = inputServicoSelect.value;
    const carro = inputCarro.value.trim();
    const desconto = parseFloat(inputDesconto.value) || 0;
    const pagamentoChecks = Array.from(document.querySelectorAll('input[name="pagamento"]:checked'));
    if (!cliente_id || !servico_id || !carro || pagamentoChecks.length === 0) {
      alert('Preencha todos os campos e selecione pelo menos uma forma de pagamento!');
      return;
    }
    const forma_pagamento = pagamentoChecks.map(i => i.value).join(',');

    // Inserir or√ßamento
    const { data: orcamento, error } = await supabase.from('orcamentos').insert({
      cliente_id,
      servico_id,
      carro,
      desconto,
      forma_pagamento,
    }).select().single();

    if (error) {
      alert('Erro ao salvar or√ßamento: ' + error.message);
      return;
    }

    // Buscar cliente e servi√ßo para gerar cupom
    const { data: cliente } = await supabase.from('clientes').select('*').eq('id', cliente_id).single();
    const { data: servico } = await supabase.from('servicos').select('*').eq('id', servico_id).single();

    const cupom = gerarCupom(orcamento, cliente, servico);
    cupomEl.textContent = cupom;
    alert('Or√ßamento salvo e cupom gerado!');
  });

  // --- Hist√≥rico ---
  const listaHistorico = document.getElementById('listaHistorico');

  async function carregarHistorico() {
    const { data: orcamentos, error } = await supabase
      .from('orcamentos')
      .select('*, clientes(*), servicos(*)')
      .order('id', { ascending: false });

    if (error) {
      alert('Erro ao carregar hist√≥rico: ' + error.message);
      return;
    }

    listaHistorico.innerHTML = '';
    orcamentos.forEach(orc => {
      const cliente = orc.clientes;
      const servico = orc.servicos;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.textContent = `#${orc.id} - ${cliente.nome} - ${servico.descricao}`;

      const btnVisualizar = document.createElement('button');
      btnVisualizar.textContent = 'üìÑ';
      btnVisualizar.title = 'Visualizar Cupom';
      btnVisualizar.onclick = () => {
        const cupom = gerarCupom(orc, cliente, servico);
        cupomEl.textContent = cupom;
        mostrarAba('orcamentos');
      };

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'üóëÔ∏è';
      btnExcluir.title = 'Excluir Or√ßamento';
      btnExcluir.onclick = async () => {
        if (confirm('Excluir or√ßamento #' + orc.id + '?')) {
          const { error } = await supabase.from('orcamentos').delete().eq('id', orc.id);
          if (error) alert('Erro ao excluir: ' + error.message);
          else carregarHistorico();
        }
      };

      div.appendChild(btnVisualizar);
      div.appendChild(btnExcluir);
      listaHistorico.appendChild(div);
    });
  }

  // --- PDF e WhatsApp ---

  document.getElementById('btnPdf').onclick = () => {
    const texto = cupomEl.textContent;
    if (!texto) return alert('Nenhum cupom para salvar.');
    const blob = new Blob([texto], { type: 'application/pdf' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'orcamento.pdf';
    link.click();
  };

  document.getElementById('btnWhats').onclick = () => {
    const texto = encodeURIComponent(cupomEl.textContent);
    if (!texto) return alert('Nenhum cupom para enviar.');
    // N√∫mero de telefone fixo ou cliente?
    const numero = '5524999486232'; // Formato internacional sem +
    const url = `https://api.whatsapp.com/send?phone=${numero}&text=${texto}`;
    window.open(url, '_blank');
  };

  // Inicializa carregamentos
  carregarClientes();
  carregarServicos();
</script>

</body>
</html>
